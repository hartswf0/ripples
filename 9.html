<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAGINARY ECOLOGIES // WORLD SIMULATOR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            background: #0a0a0a;
            height: 100%;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Play = (props) => <IconWrapper {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconWrapper>;
        const Pause = (props) => <IconWrapper {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconWrapper>;
        const RefreshCw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></IconWrapper>;
        const Zap = (props) => <IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></IconWrapper>;
        const Disc = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></IconWrapper>;
        const Plus = (props) => <IconWrapper {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconWrapper>;
        const ArrowRight = (props) => <IconWrapper {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconWrapper>;
        const Activity = (props) => <IconWrapper {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconWrapper>;
        const Box = (props) => <IconWrapper {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></IconWrapper>;
        const Hexagon = (props) => <IconWrapper {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></IconWrapper>;
        const X = (props) => <IconWrapper {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconWrapper>;

        /* --- CONFIGURATION & PRESETS --- */

        const PRESETS = [
            {
                id: 'cupboard',
                name: 'The Cupboard',
                icon: <Box className="w-6 h-6" />,
                description: 'The cupboard is spacious, yet somewhat dusty. Dark, but light seeps in through cracks. Objects are placed tightly. A quiet tension of glass and ceramic.',
                entities: [
                    'Tall Glass (Chipped)', 'Short Glass', 'Stack of Plates', 'Dead Moth', 'Ant Scout',
                    'Plastic Lid', 'Ceramic Bowl', 'Crumb', 'Dust Bunny', 'Rusty Hinge',
                    'Spider Web', 'Forgotten Receipt', 'Silver Spoon', 'Condensation Droplet', 'Wood Rot'
                ]
            },
            {
                id: 'forest',
                name: 'Deep Mycelium',
                icon: <Hexagon className="w-6 h-6" />,
                description: 'The forest floor is a network of communication. Roots tangle with fungal threads. Sunlight pierces the canopy in rare, blinding shafts.',
                entities: [
                    'Old Oak Root', 'Mycelial Network', 'Damp Moss', 'Beetle Larva', 'Falling Leaf',
                    'Stone', 'Dew Drop', 'Decaying Log', 'Spore Cloud', 'Worm',
                    'Bird Feather', 'Lichen', 'Pine Needle', 'Shadow', 'Gust of Wind'
                ]
            },
            {
                id: 'urban',
                name: 'Urban Glitch',
                icon: <Zap className="w-6 h-6" />,
                description: 'Concrete veins and neon blood. The city breathes through vents and drains. An ecology of trash, electricity, and hurried movement.',
                entities: [
                    'Discarded Cup', 'Pigeon', 'Traffic Light Reflection', 'Sewer Grate', 'Rat',
                    'Power Line Hum', 'Dandelion in Crack', 'Oil Slick', 'Lost Key', 'Security Camera',
                    'Plastic Bag', 'Rain Puddle', 'Siren Echo', 'Brick Wall', 'Graffiti Tag'
                ]
            }
        ];

        const DEFAULT_VECTORS = ['Shift Position', 'Seek Resource', 'Encounter Obstacle'];

        /* --- API UTILS --- */

        /* --- AI API UTILITIES (Unified) --- */

        const AI_CONFIG = {
            useLocalLLM: false,         // Toggle this to TRUE for local LLM
            startWithSimulated: true,   // If true, use mock data if API fails
            gemini: {
                // apiKey is passed in via function argument in this file, so we fallback to that
                model: "gemini-2.5-flash-preview-09-2025"
            },
            local: {
                endpoint: "http://localhost:11434/v1/chat/completions", // Example: Ollama
                model: "llama3"         // Model name to request
            }
        };

        const generateRipple = async (location, entities, history, selectedEntity, selectedVector, apiKey) => {

            const systemPrompt = `
            System: You are the engine of an "Imaginary Ecology". You simulate the life worlds of non-human entities.
            Tone: Operative, poetic, detached, sensory. NOT story-bookish. Focus on physics, sensation, and relation.

            Context:
            Location: ${location}
            Active Entities: ${entities.join(', ')}
            Recent History: ${history.slice(-3).map(h => h.text).join(' | ')}

            Current Action:
            The perspective is the entity: "${selectedEntity}".
            The vector/force driving this moment is: "${selectedVector}".

            Task:
            1. Describe the "Ripple" (the outcome). How does the entity react? How does the environment shift? (Max 2 sentences).
            2. Provide 3 NEW possible vectors (abstract verbs or nouns) for the NEXT turn (e.g., "Decay", "Resonate", "Block").

            Output JSON format only:
            {
                "narrative": "string",
                "newVectors": ["string", "string", "string"],
                "affectedEntities": ["string"]
            }
            `;

            const prompt = `Generate ripple for ${selectedEntity} acting with ${selectedVector}.`;

            // Decide which path to take
            if (AI_CONFIG.useLocalLLM) {
                return callLocalLLM(prompt, systemPrompt);
            } else {
                return callGemini(prompt, systemPrompt, apiKey, selectedEntity, selectedVector, location);
            }
        };

        const callLocalLLM = async (prompt, systemInstruction, isNarrative = false) => {
            const host = localStorage.getItem('ripple_ai_host') || 'localhost:11434';
            const url = `http://${host}/v1/chat/completions`;

            // 1. ADD SCHEMA INSTRUCTION
            const schemaInstruction = `\n\nOUTPUT JSON ONLY. Structure: { 
                 "narrative": "string", 
                 "newVectors": ["string"], 
                 "affectedEntities": ["string"] 
             }`;

            const payload = {
                model: AI_CONFIG.local.model,
                messages: [
                    { role: "system", content: systemInstruction + schemaInstruction },
                    { role: "user", content: prompt }
                ],
                stream: false,
                format: "json"
            };

            console.log(">> CALLING LOCAL LLM:", url);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log(">> RESPONSE STATUS:", response.status);
                if (!response.ok) throw new Error(`Local LLM Error: ${response.status}`);

                const data = await response.json();
                let content = data.choices[0].message.content;
                console.log(">> RAW CONTENT:", content);

                // 2. CLEAN UP JSON
                content = content.replace(/\/\/.*$/gm, '');
                content = content.replace(/\n/g, ' ');

                return JSON.parse(content);
            } catch (error) {
                console.warn(">> LOCAL LLM FAILED:", error);
                // Fallback to mock if desired, or return error
                // For 9.html we often use the mock fallback logic in the caller, but returning an error obj is safer:
                return {
                    error: true,
                    message: error.message || "Connection Failed",
                    details: "Check console logs."
                };
            }
        };

        const callGemini = async (prompt, systemInstruction, apiKey, selectedEntity, selectedVector, location) => {
            if (!apiKey) return mockRippleResponse(selectedEntity, selectedVector, location);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${AI_CONFIG.gemini.model}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }, // 9.html didn't use systemInstruction properly before, adding it now
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                if (!response.ok) throw new Error(`Gemini Error: ${response.status}`);
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                return result;
            } catch (error) {
                console.error("Simulation Glitch:", error);
                if (AI_CONFIG.startWithSimulated) return mockRippleResponse(selectedEntity, selectedVector, location);
                return {
                    narrative: "The simulation encountered a void. The signal was lost.",
                    newVectors: ['Retry', 'Reboot', 'Silence'],
                    affectedEntities: []
                };
            }
        };

        const mockRippleResponse = (selectedEntity, selectedVector, location) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        narrative: `Simulation Mode: The ${selectedEntity} responds to the force of ${selectedVector}. It vibrates with potential energy, altering the local arrangement of the ${location.slice(0, 10)}...`,
                        newVectors: ['Vibrate', 'Collapse', 'Expand'],
                        affectedEntities: [selectedEntity]
                    });
                }, 1500);
            });
        };

        /* --- COMPONENTS --- */

        function App() {
            const [view, setView] = useState('landing'); // landing, setup, sim
            const [apiKey, setApiKey] = useState('');

            // Simulation State
            const [config, setConfig] = useState(PRESETS[0]);
            const [vectors, setVectors] = useState(DEFAULT_VECTORS);
            const [history, setHistory] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [autoPlay, setAutoPlay] = useState(false);

            // Selection State
            const [selectedEntity, setSelectedEntity] = useState(null);
            const [selectedVector, setSelectedVector] = useState(null);

            // Auto-play Loop
            useEffect(() => {
                let interval;
                if (autoPlay && view === 'sim' && !isLoading) {
                    interval = setInterval(() => {
                        if (!selectedEntity) {
                            // AI Randomly selects entity and vector
                            const randomEntity = config.entities[Math.floor(Math.random() * config.entities.length)];
                            const randomVector = vectors[Math.floor(Math.random() * vectors.length)];
                            handleExecuteRipple(randomEntity, randomVector);
                        }
                    }, 3000); // 3 seconds between auto-turns
                }
                return () => clearInterval(interval);
            }, [autoPlay, view, isLoading, config, vectors]);

            const handleStart = (customConfig = null) => {
                if (customConfig) setConfig(customConfig);
                setHistory([{
                    id: Date.now(),
                    type: 'system',
                    text: `Simulation initialized. Location: ${customConfig ? customConfig.name : config.name}.`
                }]);
                setView('sim');
            };

            const handleExecuteRipple = async (entity, vector) => {
                setIsLoading(true);

                // Optimistic UI update
                const tempId = Date.now();

                const result = await generateRipple(
                    config.description,
                    config.entities,
                    history,
                    entity,
                    vector,
                    apiKey
                );

                setHistory(prev => [
                    {
                        id: tempId,
                        type: 'ripple',
                        entity: entity,
                        vector: vector,
                        text: result.narrative,
                        affected: result.affectedEntities
                    },
                    ...prev
                ]);

                setVectors(result.newVectors);
                setSelectedEntity(null);
                setSelectedVector(null);
                setIsLoading(false);
            };

            // Render Views
            return (
                <div className="min-h-screen bg-neutral-950 text-neutral-200 font-sans selection:bg-emerald-500/30 overflow-hidden flex flex-col">
                    {/* HEADER */}
                    <header className="h-14 border-b border-neutral-800 flex items-center justify-between px-6 bg-neutral-950/80 backdrop-blur-sm z-50">
                        <div className="flex items-center gap-2">
                            <Disc className={`w-5 h-5 ${isLoading ? 'animate-spin text-emerald-400' : 'text-neutral-500'}`} />
                            <span className="font-medium tracking-wider text-sm">IMAGINARY ECOLOGIES</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <input
                                type="password"
                                placeholder="Gemini API Key (Optional)"
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                className="bg-neutral-900 border border-neutral-800 rounded px-2 py-1 text-xs w-48 focus:outline-none focus:border-emerald-500/50"
                            />
                            {view === 'sim' && (
                                <button onClick={() => setView('landing')} className="text-xs hover:text-white transition-colors">
                                    EXIT SIMULATION
                                </button>
                            )}
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 relative">
                        {view === 'landing' && (
                            <LandingScreen onStart={handleStart} onCustom={() => setView('setup')} />
                        )}
                        {view === 'setup' && (
                            <SetupScreen onBack={() => setView('landing')} onStart={handleStart} />
                        )}
                        {view === 'sim' && (
                            <SimulationView
                                config={config}
                                history={history}
                                entities={config.entities}
                                vectors={vectors}
                                selectedEntity={selectedEntity}
                                onSelectEntity={setSelectedEntity}
                                selectedVector={selectedVector}
                                onSelectVector={setSelectedVector}
                                onExecute={handleExecuteRipple}
                                isLoading={isLoading}
                                autoPlay={autoPlay}
                                onToggleAutoPlay={() => setAutoPlay(!autoPlay)}
                            />
                        )}
                    </main>
                </div>
            );
        }

        /* --- SUB-VIEWS --- */

        function LandingScreen({ onStart, onCustom }) {
            return (
                <div className="flex flex-col items-center justify-center h-full p-8 space-y-12 animate-in fade-in duration-700">
                    <div className="text-center space-y-4 max-w-2xl">
                        <h1 className="text-4xl md:text-6xl font-light tracking-tight text-white">World Simulator</h1>
                        <p className="text-neutral-400 text-lg leading-relaxed">
                            Select a scenario to enter the life worlds of non-human entities.
                            Observe emergent interactions. Guide the ripples or let the system dream.
                        </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-5xl">
                        {PRESETS.map(preset => (
                            <button key={preset.id} onClick={() => onStart(preset)}
                                className="group relative flex flex-col items-start p-6 bg-neutral-900/50 border border-neutral-800 hover:border-emerald-500/50 hover:bg-neutral-900 transition-all duration-300 rounded-xl text-left"
                            >
                                <div className="mb-4 text-emerald-500/80 group-hover:text-emerald-400">
                                    {preset.icon}
                                </div>
                                <h3 className="text-xl text-white mb-2">{preset.name}</h3>
                                <p className="text-sm text-neutral-500 group-hover:text-neutral-400 leading-relaxed">
                                    {preset.description}
                                </p>
                            </button>
                        ))}
                    </div>

                    <div className="pt-8 border-t border-neutral-900 w-full max-w-xl text-center">
                        <button onClick={onCustom}
                            className="inline-flex items-center gap-2 text-neutral-500 hover:text-white transition-colors">
                            <Plus className="w-4 h-4" />
                            <span>Design Custom Ecology</span>
                        </button>
                    </div>
                </div>
            );
        }

        function SetupScreen({ onBack, onStart }) {
            const [name, setName] = useState('');
            const [desc, setDesc] = useState('');
            const [entitiesText, setEntitiesText] = useState('');

            const handleLaunch = () => {
                const entityList = entitiesText.split(',').map(s => s.trim()).filter(s => s.length > 0);
                if (!name || !desc || entityList.length === 0) return;

                onStart({
                    id: 'custom',
                    name,
                    description: desc,
                    entities: entityList
                });
            };

            return (
                <div className="max-w-2xl mx-auto p-8 h-full flex flex-col justify-center space-y-8 animate-in slide-in-from-bottom-4">
                    <div className="space-y-2">
                        <h2 className="text-2xl text-white">Initialize Custom Vector</h2>
                        <p className="text-neutral-500 text-sm">Define the parameters of your simulation.</p>
                    </div>

                    <div className="space-y-6">
                        <div className="space-y-2">
                            <label className="text-xs uppercase tracking-widest text-neutral-600">Location Name</label>
                            <input
                                className="w-full bg-neutral-900 border border-neutral-800 rounded p-3 text-white focus:border-emerald-500/50 outline-none"
                                placeholder="e.g., The Abandoned Mall" value={name} onChange={e => setName(e.target.value)}
                            />
                        </div>

                        <div className="space-y-2">
                            <label className="text-xs uppercase tracking-widest text-neutral-600">Environmental Context (100w max)</label>
                            <textarea
                                className="w-full h-32 bg-neutral-900 border border-neutral-800 rounded p-3 text-white focus:border-emerald-500/50 outline-none resize-none"
                                placeholder="Describe the lighting, humidity, atmosphere, and constraints..." value={desc} onChange={e => setDesc(e.target.value)}
                            />
                        </div>

                        <div className="space-y-2">
                            <label className="text-xs uppercase tracking-widest text-neutral-600">Entities (Comma Separated)</label>
                            <textarea
                                className="w-full h-24 bg-neutral-900 border border-neutral-800 rounded p-3 text-white focus:border-emerald-500/50 outline-none resize-none"
                                placeholder="Plastic Bag, Old Man, Gust of Wind, Radio Static..."
                                value={entitiesText} onChange={e => setEntitiesText(e.target.value)}
                            />
                        </div>
                    </div>

                    <div className="flex gap-4 pt-4">
                        <button onClick={onBack} className="px-6 py-2 rounded border border-neutral-800 text-neutral-400 hover:text-white transition-colors">
                            Cancel
                        </button>
                        <button
                            onClick={handleLaunch}
                            disabled={!name || !desc || !entitiesText}
                            className="flex-1 bg-white text-black font-medium rounded py-2 hover:bg-emerald-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Initialize Simulation
                        </button>
                    </div>
                </div>
            );
        }

        function SimulationView({
            config, history, entities, vectors,
            selectedEntity, onSelectEntity,
            selectedVector, onSelectVector,
            onExecute, isLoading, autoPlay, onToggleAutoPlay
        }) {
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = 0;
                }
            }, [history]);

            // Determine stage of turn
            const needsEntity = !selectedEntity && !isLoading;
            const needsVector = selectedEntity && !selectedVector && !isLoading;
            const readyToExecute = selectedEntity && selectedVector && !isLoading;

            return (
                <div className="absolute inset-0 flex flex-col md:flex-row">
                    <style>{`
                        @keyframes drift {
                            0% { transform: translate(0, 0); }
                            25% { transform: translate(10px, -15px); }
                            50% { transform: translate(-5px, 10px); }
                            75% { transform: translate(-15px, -5px); }
                            100% { transform: translate(0, 0); }
                        }
                    `}</style>

                    {/* LEFT: VISUALIZER */}
                    <div className="flex-1 relative bg-neutral-950 overflow-hidden border-r border-neutral-900">

                        {/* Background Atmosphere */}
                        <div className="absolute inset-0 opacity-20 pointer-events-none">
                            <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-emerald-900/20 via-neutral-950 to-neutral-950" />
                        </div>

                        {/* Floating Entities */}
                        <div className="absolute inset-0 p-8">
                            {entities.map((ent, i) => (
                                <EntityNode
                                    key={i}
                                    name={ent}
                                    isSelected={selectedEntity === ent}
                                    isAffected={history[0]?.affected?.includes(ent)}
                                    onClick={() => !autoPlay && !isLoading && onSelectEntity(ent)}
                                    index={i}
                                    total={entities.length}
                                />
                            ))}
                        </div>

                        {/* Status Overlay */}
                        <div className="absolute top-6 left-6 z-10 max-w-md pointer-events-none">
                            <h2 className="text-xs font-mono uppercase text-emerald-500 mb-1">Current Ecology</h2>
                            <h1 className="text-2xl text-white font-light tracking-tight mb-2">{config.name}</h1>
                            <p className="text-sm text-neutral-500 line-clamp-3">{config.description}</p>
                        </div>

                        {/* Bottom Controls (Mobile/Overlay) */}
                        <div className="absolute bottom-6 left-6 right-6 z-20 flex justify-between items-end pointer-events-none">
                            <div className="pointer-events-auto flex items-center gap-4">
                                <button
                                    onClick={onToggleAutoPlay}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-full border backdrop-blur-md transition-all ${autoPlay
                                        ? 'border-emerald-500/50 bg-emerald-900/20 text-emerald-400'
                                        : 'border-neutral-800 bg-black/50 text-neutral-400 hover:text-white'
                                        }`}
                                >
                                    {autoPlay ? <Pause className="w-4 h-4" /> : <Play className="w-4 h-4" />}
                                    <span className="text-xs font-medium uppercase tracking-wider">
                                        {autoPlay ? 'Autoplay Active' : 'Autoplay'}
                                    </span>
                                </button>
                            </div>

                            {isLoading && (
                                <div className="flex items-center gap-3 text-emerald-500/80 animate-pulse bg-black/50 px-4 py-2 rounded-full backdrop-blur">
                                    <Activity className="w-4 h-4 animate-bounce" />
                                    <span className="text-xs font-mono">CALCULATING RIPPLES...</span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* RIGHT: INTERFACE & LOG */}
                    <div className="w-full md:w-[400px] bg-neutral-950 flex flex-col border-l border-neutral-900 z-30 shadow-2xl">

                        {/* ACTION PANEL */}
                        {!autoPlay && (
                            <div className="p-6 border-b border-neutral-900 bg-neutral-900/30">
                                <div className="flex justify-between items-center mb-4">
                                    <span className="text-xs uppercase tracking-widest text-neutral-500">
                                        {needsEntity ? '1. Select Entity Perspective' : needsVector ? '2. Select Vector' : 'Ready'}
                                    </span>
                                    {selectedEntity && (
                                        <button onClick={() => { setSelectedEntity(null); setSelectedVector(null); }} className="text-neutral-600 hover:text-white">
                                            <X className="w-4 h-4" />
                                        </button>
                                    )}
                                </div>

                                {needsEntity && (
                                    <div className="text-sm text-neutral-400 italic">
                                        Select an entity from the visualizer on the left to initiate a ripple.
                                    </div>
                                )}

                                {selectedEntity && (
                                    <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
                                        <div className="flex items-center gap-2 text-emerald-400">
                                            <Box className="w-4 h-4" />
                                            <span className="font-medium">{selectedEntity}</span>
                                        </div>

                                        <div className="space-y-2">
                                            {vectors.map((vec, i) => (
                                                <button
                                                    key={i}
                                                    onClick={() => onExecute(selectedEntity, vec)}
                                                    disabled={isLoading}
                                                    className="w-full text-left px-4 py-3 rounded bg-neutral-900 border border-neutral-800 hover:border-emerald-500/50 hover:bg-neutral-800 transition-all flex justify-between group"
                                                >
                                                    <span className="text-sm text-neutral-300 group-hover:text-white">{vec}</span>
                                                    <ArrowRight className="w-4 h-4 text-neutral-700 group-hover:text-emerald-500 opacity-0 group-hover:opacity-100 transition-all" />
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* LOG FEED */}
                        <div className="flex-1 overflow-hidden relative">
                            <div className="absolute inset-0 overflow-y-auto p-6 space-y-8 custom-scrollbar" ref={scrollRef}>
                                {history.length === 0 && (
                                    <div className="text-neutral-600 text-center mt-10 text-sm">
                                        Waiting for initial disturbance...
                                    </div>
                                )}

                                {history.map((entry) => (
                                    <div key={entry.id} className="animate-in fade-in slide-in-from-bottom-2 duration-500">
                                        {entry.type === 'system' ? (
                                            <div className="flex gap-3 text-xs text-neutral-600 font-mono border-l-2 border-neutral-800 pl-3">
                                                <span>SYSTEM:</span>
                                                <span>{entry.text}</span>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                <div className="flex items-center gap-2 text-xs uppercase tracking-widest text-emerald-600/70 mb-1">
                                                    <span>{entry.entity}</span>
                                                    <ArrowRight className="w-3 h-3" />
                                                    <span>{entry.vector}</span>
                                                </div>
                                                <p className="text-neutral-300 text-sm leading-relaxed border-l border-neutral-800 pl-4 py-1">
                                                    {entry.text}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                ))}

                                {/* Spacer for bottom */}
                                <div className="h-10" />
                            </div>

                            {/* Fade overlay at bottom of log */}
                            <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-neutral-950 to-transparent pointer-events-none" />
                        </div>
                    </div>

                </div>
            );
        }

        /* --- VISUALIZER HELPERS --- */

        // A drifting node component
        function EntityNode({ name, isSelected, isAffected, onClick, index, total }) {
            // Generate deterministic "random" positions based on index
            const r = (n) => ((index * n * 7919) % 100) / 100;
            const top = 10 + r(13) * 80; // 10% to 90%
            const left = 10 + r(27) * 80;

            // Animation delay
            const delay = r(5) * 5;

            return (
                <div
                    onClick={onClick}
                    className={`absolute cursor-pointer transition-all duration-1000 ease-in-out group
                        ${isSelected ? 'z-50 scale-110' : 'z-10 hover:z-40'}
                    `}
                    style={{
                        top: `${top}%`,
                        left: `${left}%`,
                        animation: `drift ${20 + r(10) * 20}s infinite alternate ease-in-out -${delay}s`
                    }}
                >
                    <div className={`
                        relative flex items-center justify-center
                        transition-all duration-500
                        ${isSelected ? 'scale-100' : 'scale-90 hover:scale-105'}
                    `}>
                        {/* Node Shape */}
                        <div className={`
                            w-3 h-3 rounded-full border 
                            ${isSelected
                                ? 'bg-emerald-500 border-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.5)]'
                                : isAffected
                                    ? 'bg-neutral-200 border-white shadow-[0_0_10px_rgba(255,255,255,0.3)] animate-pulse'
                                    : 'bg-neutral-900 border-neutral-700 group-hover:border-neutral-500'
                            }
                        `} />

                        {/* Label (Hidden usually, shown on hover/select) */}
                        <div className={`
                            absolute left-5 whitespace-nowrap text-xs tracking-wide px-2 py-1 rounded bg-black/80 backdrop-blur border border-neutral-800
                            transition-opacity duration-300
                            ${isSelected || isAffected ? 'opacity-100' : 'opacity-40 group-hover:opacity-100'}
                            ${isSelected ? 'text-emerald-400 border-emerald-900' : 'text-neutral-400'}
                        `}>
                            {name}
                        </div>

                        {/* Connection Lines (Decoration) */}
                        {isSelected && (
                            <div className="absolute inset-0 -z-10 w-[200px] h-[1px] bg-gradient-to-r from-emerald-500/50 to-transparent rotate-45 origin-left animate-pulse" />
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>