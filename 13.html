<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIPPLES_ENGINE_v4.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --term-bg: #050a05;
            --term-text: #4af626;
            --term-dim: #1e5c12;
            --term-alert: #ff3333;
            --term-highlight: #ccffcc;
            --term-gold: #ffd700;
        }

        .font-term {
            font-family: 'Courier New', Courier, monospace;
        }

        .crt-screen {
            background-color: var(--term-bg);
            color: var(--term-text);
            position: relative;
            overflow: hidden;
        }

        .crt-overlay::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 50;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .crt-overlay::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: 0;
            z-index: 50;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }

        @keyframes flicker {
            0% {
                opacity: 0.02;
            }

            50% {
                opacity: 0.05;
            }

            100% {
                opacity: 0.02;
            }
        }

        .term-border {
            border: 1px solid var(--term-dim);
        }

        .term-btn {
            border: 1px solid var(--term-dim);
            transition: all 0.2s;
            background: transparent;
            color: var(--term-text);
        }

        .term-btn:hover:not(:disabled) {
            background: var(--term-dim);
            color: var(--term-highlight);
            cursor: pointer;
        }

        .term-btn.active {
            background: var(--term-text);
            color: var(--term-bg);
            border-color: var(--term-text);
        }

        .radar-line {
            stroke: var(--term-dim);
            stroke-width: 1;
            vector-effect: non-scaling-stroke;
        }

        .radar-line.active {
            stroke: var(--term-highlight);
            stroke-dasharray: 5, 5;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        .nature-show-overlay {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
            border-top: 2px solid var(--term-gold);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Zap = (props) => <IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></IconWrapper>;
        const Play = (props) => <IconWrapper {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconWrapper>;
        const Pause = (props) => <IconWrapper {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconWrapper>;
        const Activity = (props) => <IconWrapper {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconWrapper>;
        const Disc = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></IconWrapper>;
        const Box = (props) => <IconWrapper {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></IconWrapper>;
        const Wind = (props) => <IconWrapper {...props}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"></path><path d="M9.6 4.6A2 2 0 1 1 11 8H2"></path><path d="M12.6 19.4A2 2 0 1 0 14 16H2"></path></IconWrapper>;
        const Terminal = (props) => <IconWrapper {...props}><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></IconWrapper>;
        const Radio = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></IconWrapper>;
        const Mic = (props) => <IconWrapper {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></IconWrapper>;
        const History = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"></path><path d="M3 3v9h9"></path><polyline points="12 7 12 12 15 15"></polyline></IconWrapper>;
        const Layers = (props) => <IconWrapper {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></IconWrapper>;
        const Eye = (props) => <IconWrapper {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></IconWrapper>;

        // --- GEMINI API UTILITIES ---
        const apiKey = ""; // Runtime environment provides this

        const callGemini = async (prompt, systemInstruction, isNarrative = false) => {
            if (!apiKey) {
                // Mock response logic
                if (isNarrative) {
                    return { script: "Simulation Mode: The entity vibrates with a low hum, observing its surroundings with a keen digital sense...", tone: "Simulated" };
                } else {
                    return new Promise(resolve => setTimeout(() => resolve({
                        narrative: "Entity interacts with environment (Simulated).",
                        entityUpdates: [],
                        nextVectors: ["SHIFT", "VOID", "MATURE"],
                        ecologicalDrift: Math.random()
                    }), 1000));
                }
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const responseSchema = isNarrative ? {
                type: "OBJECT",
                properties: {
                    script: { type: "STRING" },
                    tone: { type: "STRING" }
                }
            } : {
                type: "OBJECT",
                properties: {
                    narrative: { type: "STRING" },
                    entityUpdates: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                id: { type: "INTEGER" },
                                status: { type: "STRING" },
                                x: { type: "NUMBER" },
                                y: { type: "NUMBER" }
                            }
                        }
                    },
                    nextVectors: {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    },
                    ecologicalDrift: { type: "NUMBER" } // Track global environmental shift
                }
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            let attempt = 0;
            const maxRetries = 3;
            const delays = [1000, 2000, 4000];

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST', headers: {
                            'Content-Type'
                                : 'application/json'
                        }, body: JSON.stringify(payload)
                    }); if (!response.ok) throw new Error(`HTTP Error:
                ${response.status}`); const data = await response.json(); const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    return JSON.parse(text);
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error; await new Promise(r =>
                        setTimeout(r, delays[attempt]));
                    attempt++;
                }
            }
        };

        // --- DATA PRESETS ---
        const SCENES = {
            cupboard: {
                title: "CUPBOARD_03",
                description: "BOUNDARY: Wood/Darkness. PHYSICS: High Friction. SILENCE: Absolute.",
                entities: [
                    { name: "Tall Glass 1", icon: "ðŸ¥›" }, { name: "Tall Glass 2", icon: "ðŸ¥›" },
                    { name: "Short Glass A", icon: "ðŸ¥ƒ" }, { name: "Short Glass B", icon: "ðŸ¥ƒ" },
                    { name: "Plate Stack", icon: "ðŸ½ï¸" }, { name: "Ant Scout", icon: "ðŸœ" },
                    { name: "Glass Box", icon: "ðŸ§Š" }, { name: "Plastic Lid", icon: "â­•" },
                    { name: "Spider", icon: "ðŸ•·ï¸" }, { name: "Dust Bunny", icon: "ðŸ’¨" },
                    { name: "Light Beam", icon: "âœ¨" }, { name: "Draft", icon: "ðŸŒ¬ï¸" }
                ]
            },
            forest: {
                title: "FOREST_NODE_9",
                description: "BOUNDARY: Organic/Open. PHYSICS: Damp/Growth. NOISE: Low hum.",
                entities: [
                    { name: "Old Oak", icon: "ðŸŒ³" }, { name: "Fern", icon: "ðŸŒ¿" },
                    { name: "River Stone", icon: "ðŸª¨" }, { name: "Fox", icon: "ðŸ¦Š" },
                    { name: "Mycelium", icon: "ðŸ•¸ï¸" }, { name: "Dew Drop", icon: "ðŸ’§" },
                    { name: "Moonlight", icon: "ðŸŒ™" }, { name: "Wind Gust", icon: "ðŸŒ¬ï¸" },
                    { name: "Mushroom", icon: "ðŸ„" }, { name: "Crow", icon: "ðŸ¦â€â¬›" }
                ]
            },
            void: {
                title: "SECTOR_VOID_ZERO",
                description: "BOUNDARY: Vacuum. PHYSICS: Zero-G. LIGHT: Distant/Cold.",
                entities: [
                    { name: "Satellite", icon: "ðŸ›°ï¸" }, { name: "Asteroid", icon: "â˜„ï¸" },
                    { name: "Void", icon: "âš«" }, { name: "Comet", icon: "ðŸŒ " },
                    { name: "Nebula Gas", icon: "ðŸŒ«ï¸" }, { name: "Solar Flare", icon: "â˜€ï¸" },
                    { name: "Space Junk", icon: "ðŸ”©" }, { name: "Gravity Well", icon: "ðŸŒ€" }
                ]
            }
        };

        function ImaginaryEcologies() {
            const [mode, setMode] = useState('SETUP');
            const [sceneData, setSceneData] = useState(null);
            const [entities, setEntities] = useState([]);
            const [history, setHistory] = useState([]);
            const [phase, setPhase] = useState('IDLE');
            const [selectedEntityId, setSelectedEntityId] = useState(null);
            const [vectors, setVectors] = useState(['DRIFT', 'OBSERVE', 'EXPAND']);
            const [autoPlay, setAutoPlay] = useState(false);
            const [tick, setTick] = useState(402);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [natureShowScript, setNatureShowScript] = useState(null);
            const [isBroadcasting, setIsBroadcasting] = useState(false);

            const logEndRef = useRef(null);
            const autoPlayTimer = useRef(null);

            useEffect(() => {
                const interval = setInterval(() => setTick(t => t + Math.floor(Math.random() * 15)), 1000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                logEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [history]);

            useEffect(() => {
                if (phase === 'PROCESSING') {
                    let p = 0;
                    const interval = setInterval(() => {
                        p = Math.min(p + Math.random() * 20, 95);
                        setLoadingProgress(p);
                    }, 100);
                    return () => clearInterval(interval);
                } else {
                    setLoadingProgress(0);
                }
            }, [phase]);

            const startSimulation = (presetKey) => {
                const preset = SCENES[presetKey];
                const initialEntities = preset.entities.map((e, i) => ({
                    id: i, ...e, status: "STABLE", x: Math.random() * 80 + 10, y: Math.random() * 80 + 10
                }));
                setSceneData(preset);
                setEntities(initialEntities);
                setHistory([{ timestamp: tick, type: 'SYSTEM', text: `INIT_SEQ_COMPLETE: ${preset.title} LOADED.` }]);
                setMode('SIMULATION');
                setPhase('SELECT_ENTITY');
            };

            const triggerRipple = async (entityId, vector) => {
                setPhase('PROCESSING');
                setIsBroadcasting(false);
                const entity = entities.find(e => e.id === entityId);

                const systemPrompt = `
                You are RIPPLES_ENGINE_v4.2. Simulate emergent interactions in an imaginary ecology.
                Maintain a persistent world state. Actions have lasting physical consequences.
                Output strictly valid JSON as defined.
                `;

                const userPrompt = `
                CONTEXT: ${sceneData.description}
                ACTION: Entity [${entity.name}] executes [${vector}] vector.
                HISTORY: ${history.slice(-3).map(h => h.result || h.text).join(' | ')}
                `;

                try {
                    const result = await callGemini(userPrompt, systemPrompt);
                    if (result.entityUpdates) {
                        setEntities(prev => prev.map(e => {
                            const update = result.entityUpdates.find(u => u.id === e.id || u.name === e.name);
                            return update ? { ...e, status: update.status || e.status, x: update.x ?? e.x, y: update.y ?? e.y } : e;
                        }));
                    }
                    setVectors(result.nextVectors || ['SHIFT', 'VOID', 'MATURE']);
                    setHistory(prev => [...prev, {
                        timestamp: tick + 42, type: 'TRANSACTION', entity: entity.name, vector, result:
                            result.narrative
                    }]);
                    setSelectedEntityId(null);
                    setPhase('SELECT_ENTITY');
                } catch (error) {
                    setHistory(prev => [...prev, { timestamp: tick, type: 'ERROR', text: "SIM_GLITCH" }]);
                    setPhase('SELECT_ENTITY');
                }
            };

            const getNearestNeighbors = (targetId) => {
                const target = entities.find(e => e.id === targetId);
                if (!target) return [];
                return entities.filter(e => e.id !== targetId)
                    .map(e => ({ ...e, dist: Math.hypot(e.x - target.x, e.y - target.y) }))
                    .sort((a, b) => a.dist - b.dist).slice(0, 3);
            };

            const generateNatureShow = async () => {
                if (selectedEntityId === null) return;
                setIsBroadcasting(true);
                const entity = entities.find(e => e.id === selectedEntityId);

                const systemPrompt = `
                You are Sir David Attenborough narrating a nature documentary about nonhuman imaginary ecologies.
                Style: Hushed, breathless, emphasizing survival niches, evolutionary oddities, and the drama of the mundane.
                Structure the script with pauses: (pause) or (whispers).
                `;

                const userPrompt = `
                The subject is [${entity.name}]. Its current status is [${entity.status}].
                It is surrounded by: ${getNearestNeighbors(selectedEntityId).map(n => n.name).join(', ')}.
                Describe its struggle in this ${sceneData.title} environment.
                `;

                try {
                    const result = await callGemini(userPrompt, systemPrompt, true);
                    setNatureShowScript(result.script);
                } catch (error) {
                    setNatureShowScript("The signal is lost in the static of the wild...");
                }
            };

            const handleEntityClick = (id) => {
                if (phase === 'PROCESSING') return;
                setSelectedEntityId(id === selectedEntityId ? null : id);
                if (id !== selectedEntityId) setPhase('SELECT_VECTOR');
                else setPhase('SELECT_ENTITY');
            };

            const selectedEntity = entities.find(e => e.id === selectedEntityId);
            const nearbyEntities = selectedEntityId ? getNearestNeighbors(selectedEntityId) : [];

            if (mode === 'SETUP') {
                return (
                    <div className="h-screen w-full bg-black flex items-center justify-center font-term crt-screen crt-overlay">
                        <div
                            className="max-w-4xl w-full p-8 border-2 border-[var(--term-dim)] bg-[var(--term-bg)] shadow-[0_0_20px_rgba(74,246,38,0.1)]">
                            <header className="mb-8 border-b border-[var(--term-dim)] pb-4 flex justify-between items-end">
                                <div>
                                    <h1 className="text-4xl font-bold tracking-tighter text-[var(--term-text)]">RIPPLES_ENGINE_v4.2</h1>
                                    <p className="text-[var(--term-dim)] mt-2">{'{'}{'>'}{'}'} INITIALIZING IMAGINARY ECOLOGIES
                                        PROTOCOL...</p>
                                </div>
                                <div className="text-right text-xs text-[var(--term-dim)]">MEM: 128KB // READY</div>
                            </header>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {Object.entries(SCENES).map(([key, data]) => (
                                    <button key={key} onClick={() => startSimulation(key)} className="group p-4 term-btn text-left h-48 flex
                                flex-col justify-between">
                                        <div>
                                            <div className="text-2xl mb-2 text-[var(--term-dim)]">
                                                <Box />
                                            </div>
                                            <h3 className="text-lg font-bold text-[var(--term-text)] uppercase">LOAD_{key}</h3>
                                        </div>
                                        <div className="text-xs text-[var(--term-dim)] font-mono leading-tight">{data.description}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen w-full bg-black font-term crt-screen crt-overlay flex items-center justify-center p-4">
                    <div
                        className="w-full max-w-[1400px] h-[90vh] border-2 border-[var(--term-dim)] bg-[var(--term-bg)] grid grid-cols-[320px_1fr] grid-rows-[auto_1fr_auto]">

                        {/* HEADER */}
                        <header
                            className="col-span-2 border-b border-[var(--term-dim)] p-3 flex justify-between items-center bg-[var(--term-bg)] z-10">
                            <div className="flex items-center gap-4">
                                <Terminal size={18} />
                                <span className="font-bold">SYS.ROOT // RIPPLES_ENGINE_v4.2</span>
                                <span
                                    className="text-xs px-2 py-0.5 border border-[var(--term-dim)] text-[var(--term-dim)] uppercase">{sceneData.title}</span>
                            </div>
                            <div className="text-sm flex gap-4 items-center">
                                <div className="flex items-center gap-1 text-[var(--term-dim)]">
                                    <Activity size={12} /> DRIFT: +0.02%
                                </div>
                                <span>TICK: {tick}ms</span>
                            </div>
                        </header>

                        {/* SIDEBAR */}
                        <aside
                            className="border-r border-[var(--term-dim)] p-4 overflow-y-auto flex flex-col gap-4 bg-[rgba(0,0,0,0.2)]">
                            <div className="term-border p-2 relative">
                                <span
                                    className="absolute -top-3 left-2 bg-[var(--term-bg)] px-2 text-[10px] font-bold text-[var(--term-dim)]">01.
                                    WORLD_STATE</span>
                                <div className="mt-2 text-[10px] space-y-1">
                                    <div>ENTITIES: {entities.length}</div>
                                    <div>PHASE: {phase}</div>
                                    {phase === 'PROCESSING' && <div className="w-full h-1 bg-[var(--term-dim)] mt-2">
                                        <div className="h-full bg-[var(--term-text)]" style={{ width: `${loadingProgress}%` }} />
                                    </div>}
                                </div>
                            </div>

                            <div className="term-border p-2 relative flex-1 flex flex-col">
                                <span
                                    className="absolute -top-3 left-2 bg-[var(--term-bg)] px-2 text-[10px] font-bold text-[var(--term-dim)]">02.
                                    PERSPECTIVE_CORE</span>
                                {selectedEntity ? (
                                    <div className="mt-3 flex flex-col h-full space-y-4">
                                        <div className="text-center">
                                            <div className="text-4xl mb-1">{selectedEntity.icon}</div>
                                            <div className="font-bold uppercase text-sm">{selectedEntity.name}</div>
                                        </div>
                                        <div className="space-y-3">
                                            <div>
                                                <div
                                                    className="text-[9px] text-[var(--term-dim)] uppercase tracking-widest flex items-center gap-1">
                                                    <Layers size={10} /> Status
                                                </div>
                                                <div className="text-xs border border-[var(--term-dim)] p-1.5">{selectedEntity.status}
                                                </div>
                                            </div>
                                            <div>
                                                <div
                                                    className="text-[9px] text-[var(--term-dim)] uppercase tracking-widest flex items-center gap-1">
                                                    <History size={10} /> State_Debt
                                                </div>
                                                <div className="text-xs border border-[var(--term-dim)] p-1.5 font-mono">
                                                    HASH_{Math.random().toString(36).substr(2, 4)}</div>
                                            </div>
                                        </div>
                                        <button onClick={generateNatureShow}
                                            className="mt-auto term-btn py-2 text-[10px] font-bold flex items-center justify-center gap-2 border-[var(--term-gold)] text-[var(--term-gold)] hover:bg-[var(--term-gold)] hover:text-black">
                                            <Mic size={12} /> BROADCAST_SHOW
                                        </button>
                                    </div>
                                ) : (
                                    <div className="mt-2 space-y-1 overflow-y-auto">
                                        {entities.map(e => (
                                            <button key={e.id} onClick={() => handleEntityClick(e.id)} className="w-full text-left
                                        text-[10px] p-1.5 border border-transparent hover:border-[var(--term-dim)] flex
                                        justify-between">
                                                <span>{e.name}</span>
                                                <span className="text-[var(--term-dim)]">{e.status}</span>
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="term-border p-2 relative">
                                <span
                                    className="absolute -top-3 left-2 bg-[var(--term-bg)] px-2 text-[10px] font-bold text-[var(--term-dim)]">03.
                                    VECTOR_INJECT</span>
                                <div className="mt-2 grid grid-cols-1 gap-1">
                                    {vectors.map((v, i) => (
                                        <button key={i} onClick={() => triggerRipple(selectedEntityId, v)} disabled={!selectedEntityId ||
                                            phase === 'PROCESSING'} className="term-btn py-2 text-[10px] font-bold uppercase
                                        disabled:opacity-30">
                                            {v}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </aside>

                        {/* MAIN DISPLAY */}
                        <main className="relative flex flex-col bg-[var(--term-bg)] overflow-hidden">
                            <div
                                className="flex-1 relative border-b border-[var(--term-dim)] bg-[rgba(5,10,5,0.8)] overflow-hidden">
                                <div className="absolute top-2 left-2 text-[9px] text-[var(--term-dim)] font-bold z-10">
                                    <Eye size={10} className="inline mr-1" /> VISUAL_MATRIX // {selectedEntityId ? 'FOCUS_LOCKED' :
                                        'SCANNING_'}
                                </div>
                                <div className="absolute inset-0 opacity-10 pointer-events-none" style={{
                                    backgroundImage: 'linear-gradient(var(--term-dim) 1px, transparent 1px), linear-gradient(90deg, var(--term-dim) 1px, transparent 1px)'
                                    , backgroundSize: '40px 40px'
                                }} />

                                <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
                                    {selectedEntity && nearbyEntities.map(n => (
                                        <line key={n.id} x1={`${selectedEntity.x}%`} y1={`${selectedEntity.y}%`} x2={`${n.x}%`}
                                            y2={`${n.y}%`} className="radar-line active" />
                                    ))}
                                </svg>

                                {entities.map(ent => (
                                    <div key={ent.id} onClick={() => handleEntityClick(ent.id)} className={`absolute transition-all
                                    duration-1000 transform -translate-x-1/2 -translate-y-1/2 cursor-pointer ${selectedEntityId ===
                                            ent.id ? 'z-50' : 'z-10'}`} style={{ left: `${ent.x}%`, top: `${ent.y}%` }}>
                                        {selectedEntityId === ent.id &&
                                            <div className="absolute -inset-4 border border-[var(--term-text)] animate-pulse" />}
                                        <div className={`text-2xl transition-all ${selectedEntityId === ent.id ? 'scale-125'
                                            : 'brightness-50 grayscale sepia'}`}>{ent.icon}</div>
                                        <div
                                            className="absolute top-full left-1/2 -translate-x-1/2 mt-1 text-[8px] whitespace-nowrap opacity-0 hover:opacity-100">
                                            {ent.name}</div>
                                    </div>
                                ))}

                                {isBroadcasting && (
                                    <div
                                        className="absolute bottom-0 left-0 right-0 nature-show-overlay p-6 z-40 animate-in slide-in-from-bottom duration-500">
                                        <div className="max-w-3xl mx-auto flex gap-4">
                                            <div className="shrink-0 flex flex-col items-center">
                                                <Mic size={24} className="text-[var(--term-gold)] animate-pulse mb-2" />
                                                <div
                                                    className="text-[8px] text-[var(--term-gold)] font-bold tracking-[0.2em] vertical-rl">
                                                    NATURE_SHOW</div>
                                            </div>
                                            <div className="flex-1">
                                                <div
                                                    className="text-[9px] text-[var(--term-gold)] font-bold mb-2 uppercase tracking-widest flex items-center justify-between">
                                                    <span>Transmission Perspective: {selectedEntity?.name}</span>
                                                    <button onClick={() => setIsBroadcasting(false)} className="hover:text-white">CLOSE
                                                        [X]</button>
                                                </div>
                                                <p className="text-sm md:text-base leading-relaxed text-[var(--term-highlight)] italic">
                                                    "{natureShowScript || 'Syncing vocal patterns... preparing observation...'}"
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="h-[200px] bg-black p-4 overflow-y-auto border-t border-[var(--term-dim)] relative">
                                <div
                                    className="text-[10px] text-[var(--term-dim)] font-bold mb-2 sticky top-0 bg-black w-full pb-1 border-b border-[var(--term-dim)] flex justify-between">
                                    <span>{'{'}{'>'}{'}'} WORLD_STATE_TIMELINE.log</span>
                                    <span>PRINT_MODE: SECURE</span>
                                </div>
                                <div className="space-y-4 pb-8">
                                    {history.map((entry, idx) => (
                                        <div key={idx} className={`text-[10px] md:text-xs font-mono animate-in fade-in duration-300`}>
                                            {entry.type === 'TRANSACTION' ? (
                                                <div className="border-l border-[var(--term-dim)] pl-3">
                                                    <div
                                                        className="flex justify-between text-[8px] text-[var(--term-dim)] uppercase tracking-tighter mb-1">
                                                        <span>T+{entry.timestamp}</span>
                                                        <span>VECTOR: {entry.vector}</span>
                                                    </div>
                                                    <div className="font-bold text-[var(--term-highlight)]">[{entry.entity}]</div>
                                                    <div className="text-[var(--term-text)] leading-snug">{entry.result}</div>
                                                </div>
                                            ) : (
                                                <div className="text-[var(--term-dim)] italic opacity-60 italic">{`[${entry.timestamp}]
                                            ${entry.text}`}</div>
                                            )}
                                        </div>
                                    ))}
                                    <div ref={logEndRef} />
                                </div>
                            </div>
                        </main>

                        <footer
                            className="col-span-2 border-t border-[var(--term-dim)] p-2 text-[9px] text-[var(--term-dim)] flex justify-between items-center bg-[var(--term-bg)]">
                            <div>SCENE_GRAPH_STABLE // HASH: 0xF9{tick.toString(16)} // NODES: {entities.length}</div>
                            <button onClick={() => setMode('SETUP')} className="hover:text-white">[ SHUTDOWN ]</button>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ImaginaryEcologies />);
    </script>
</body>

</html>