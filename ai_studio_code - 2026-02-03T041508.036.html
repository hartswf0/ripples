<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIPPLES v3.5 // OMNISCIENT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg: #050505;
            --term: #33ff00;
            --dim: #113311;
            --cyan: #00ffff;
            --gold: #ffcc00;
            --red: #ff3333;
            --font: 'JetBrains Mono', monospace;
        }

        body {
            background: var(--bg);
            color: var(--term);
            font-family: var(--font);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- CRT OVERLAY (Conditional) --- */
        #crt-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 50; opacity: 0.5;
            mix-blend-mode: overlay;
            transition: opacity 0.5s;
        }
        
        body.tui-mode #crt-layer { opacity: 0; }
        body.tui-mode * { text-shadow: none !important; box-shadow: none !important; }
        body.tui-mode canvas { filter: none !important; }

        /* --- MAIN VIEWPORT --- */
        #viewport {
            flex-grow: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        
        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
            transition: filter 0.3s;
        }

        /* --- HUD (Heads Up Display) --- */
        #hud {
            position: absolute; top: 20px; right: 20px;
            text-align: right; pointer-events: none;
            font-size: 12px; color: var(--term);
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border: 1px solid var(--dim);
        }
        
        .hud-row { margin-bottom: 4px; }
        .hud-label { color: var(--dim); font-size: 10px; text-transform: uppercase; }
        .hud-val { font-weight: bold; }
        .blink { animation: blink 1s infinite; }
        
        @keyframes blink { 50% { opacity: 0; } }

        /* --- TERMINAL (Chat) --- */
        #terminal-wrapper {
            height: 200px;
            background: #080808;
            border-top: 1px solid var(--term);
            display: flex;
            flex-direction: column;
            padding: 10px 20px;
            font-size: 14px;
            z-index: 60;
        }

        #history {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            color: #888;
            font-size: 12px;
            display: flex;
            flex-direction: column-reverse; /* Bottom up */
        }

        .msg-sys { color: var(--cyan); }
        .msg-err { color: var(--red); }
        .msg-user { color: #fff; opacity: 0.5; }

        #input-line { display: flex; align-items: center; }
        #prompt { color: var(--term); margin-right: 10px; font-weight: bold; }
        
        input {
            flex-grow: 1; background: transparent; border: none;
            color: #fff; font-family: var(--font); font-size: 14px;
            outline: none; text-transform: uppercase;
        }

        /* --- BOOT SCREEN --- */
        #boot {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="crt-layer"></div>

    <div id="viewport">
        <canvas id="canvas"></canvas>
        
        <div id="hud">
            <div class="hud-row"><span class="hud-label">SCENARIO</span> <span id="hud-scene" class="hud-val" style="color:var(--cyan)">VOID</span></div>
            <div class="hud-row"><span class="hud-label">TICK_RATE</span> <span id="hud-speed" class="hud-val">0ms</span></div>
            <div class="hud-row"><span class="hud-label">ENTITIES</span> <span id="hud-ents" class="hud-val">0</span></div>
            <div style="border-top: 1px dashed var(--dim); margin: 5px 0;"></div>
            <div class="hud-row"><span class="hud-label">TRACKING_ID</span> <span id="track-id" class="hud-val">NULL</span></div>
            <div class="hud-row"><span class="hud-label">UMWELT</span> <span id="track-state" class="hud-val">---</span></div>
        </div>
    </div>

    <div id="terminal-wrapper">
        <div id="history"></div>
        <div id="input-line">
            <span id="prompt">DEMIURGE@CORE:~$</span>
            <input type="text" id="cmd-input" placeholder="Type 'HELP' for protocols..." autofocus autocomplete="off">
        </div>
    </div>

    <div id="boot" onclick="boot()">
        <h1 style="color:var(--term); text-shadow: 0 0 15px var(--term);">RIPPLES v3.5</h1>
        <p style="color:var(--dim); font-size:12px;">[CLICK TO INITIALIZE OMNISCIENT INTERFACE]</p>
    </div>

<script>
    /**
     * RIPPLES v3.5 - OMNISCIENT TERMINAL
     * Features: Tracking, Speed Control, TUI Mode, Chat Logic
     */

    // --- CONFIG ---
    const COLS = 60;
    const ROWS = 28;
    
    // --- SCENARIOS ---
    const SCENARIOS = {
        'VOID': { bg: '.', colors: { bg: '#222' } },
        'CUPBOARD': { bg: '·', wall: '#', colors: { bg: '#444', agent: '#fff', goal: '#fc0', obs: '#f33' }, chars: { agent:'A', goal:'G', obs:'O'} },
        'FOREST': { bg: ',', wall: 'T', colors: { bg: '#252', agent: '#0f0', goal: '#0ff', obs: '#555' }, chars: { agent:'M', goal:'R', obs:'S'} },
        'CITY': { bg: '+', wall: '█', colors: { bg: '#333', agent: '#f0f', goal: '#0f0', obs: '#f00' }, chars: { agent:'R', goal:'$', obs:'X'} }
    };

    // --- STATE ---
    let state = {
        grid: [],
        agents: [],
        ripples: [],
        currentScene: 'VOID',
        tick: 0,
        running: false,
        speed: 100, // ms
        mode: 'CRT', // or TUI
        trackedIndex: null // Index of agent being followed
    };

    // --- AUDIO ---
    const Audio = {
        ready: false,
        synth: null,
        init: async () => {
            await Tone.start();
            Audio.synth = new Tone.PolySynth(Tone.Synth).toDestination();
            Audio.synth.volume.value = -12;
            Audio.ready = true;
        },
        play: (note) => {
            if(Audio.ready && state.running) Audio.synth.triggerAttackRelease(note, "32n");
        }
    };

    // --- ENGINE CORE ---
    function init() {
        state.grid = Array(ROWS * COLS).fill({ char: '.', color: '#222' });
        resize();
        loop();
    }

    function updatePhysics() {
        // 1. RIPPLES
        let activeRipples = [];
        state.ripples.forEach(r => {
            r.radius += (r.type === 'SHIFT' ? 1.5 : 0.8);
            
            // Grid Effect
            for(let i=0; i<state.grid.length; i++) {
                const gx = i % COLS; const gy = Math.floor(i / COLS);
                const dist = Math.sqrt((gx - r.x)**2 + (gy - r.y)**2);
                
                if (dist < r.radius && dist > r.radius - 2) {
                    if (r.type === 'SHIFT') {
                        const scene = SCENARIOS[r.payload];
                        state.grid[i] = { 
                            char: Math.random() > 0.9 ? scene.wall || '#' : scene.bg, 
                            color: Math.random() > 0.9 ? '#555' : '#112211'
                        };
                        // Kill agents outside safe zone
                        state.agents = state.agents.filter(a => Math.sqrt((a.x-r.x)**2 + (a.y-r.y)**2) > r.radius);
                    }
                    else if (r.type === 'CLEAR') {
                        state.grid[i] = { char: '.', color: '#222' };
                        state.agents = [];
                    }
                }
            }
            if (r.radius < r.maxRadius * 1.5) activeRipples.push(r);
        });
        state.ripples = activeRipples;

        // 2. AGENTS
        state.agents.forEach(a => {
            // Logic: Move towards nearest goal or random
            if(Math.random() > 0.3) {
                const dx = Math.floor(Math.random()*3)-1;
                const dy = Math.floor(Math.random()*3)-1;
                
                const nx = a.x + dx;
                const ny = a.y + dy;

                if(nx >= 0 && nx < COLS && ny >= 0 && ny < ROWS) {
                    // Collision check with other agents
                    const hit = state.agents.find(o => o !== a && o.x === nx && o.y === ny);
                    
                    if (!hit) {
                        a.x = nx;
                        a.y = ny;
                        if(a.type === 'agent') a.state = "WANDERING";
                    } else {
                        if(a.type === 'agent') {
                            a.state = "COLLISION";
                            if(hit.type === 'goal') {
                                hit.dead = true; // Eat goal
                                Audio.play("C5");
                                a.state = "CONSUMING";
                            }
                        }
                    }
                }
            }
        });
        
        // Cleanup dead entities
        state.agents = state.agents.filter(a => !a.dead);
        
        // Tracking check
        if(state.trackedIndex !== null) {
            if(!state.agents[state.trackedIndex]) state.trackedIndex = null; // Lost tracking
        }
    }

    // --- RENDERER ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function resize() {
        canvas.width = canvas.parentElement.offsetWidth;
        canvas.height = canvas.parentElement.offsetHeight;
    }
    window.addEventListener('resize', resize);

    function draw() {
        const isTUI = state.mode === 'TUI';
        
        // Clear (Decay for CRT, Solid for TUI)
        ctx.fillStyle = isTUI ? '#000' : 'rgba(5, 5, 5, 0.4)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const scaleX = canvas.width / COLS;
        const scaleY = canvas.height / ROWS;
        
        ctx.font = `${Math.floor(scaleY)}px "JetBrains Mono"`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // Draw Grid
        for(let i=0; i<state.grid.length; i++) {
            const x = i % COLS; const y = Math.floor(i / COLS);
            const cell = state.grid[i];
            
            ctx.fillStyle = isTUI ? '#333' : cell.color;
            if(cell.char !== '.' && cell.char !== ' ') {
                ctx.fillText(cell.char, x * scaleX + scaleX/2, y * scaleY + scaleY/2);
            }
        }

        // Draw Agents
        const scene = SCENARIOS[state.currentScene] || SCENARIOS['VOID'];
        state.agents.forEach((a, idx) => {
            const char = scene.chars[a.type] || '?';
            const color = scene.colors[a.type] || '#fff';
            
            const px = a.x * scaleX + scaleX/2;
            const py = a.y * scaleY + scaleY/2;

            // Tracking Highlight
            if(state.trackedIndex === idx) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.strokeRect(a.x * scaleX, a.y * scaleY, scaleX, scaleY);
                // HUD Update
                document.getElementById('track-id').innerText = `ID_${idx}`;
                document.getElementById('track-state').innerText = a.state;
            }

            ctx.fillStyle = color;
            if(!isTUI) {
                ctx.shadowBlur = 5;
                ctx.shadowColor = color;
            }
            ctx.fillText(char, px, py);
            ctx.shadowBlur = 0;
        });

        // Draw Ripples (Visual Only)
        if(!isTUI) {
            state.ripples.forEach(r => {
                const cx = r.x * scaleX;
                const cy = r.y * scaleY;
                const rad = r.radius * Math.max(scaleX, scaleY);
                ctx.beginPath();
                ctx.arc(cx, cy, rad, 0, Math.PI * 2);
                ctx.strokeStyle = r.type === 'SHIFT' ? 'rgba(0,255,255,0.5)' : 'rgba(255,255,255,0.3)';
                ctx.stroke();
            });
        }

        // Update HUD Global
        document.getElementById('hud-ents').innerText = state.agents.length;
    }

    // --- GAME LOOP ---
    function loop() {
        if(state.running) {
            state.tick++;
            updatePhysics();
        }
        draw();
        setTimeout(() => requestAnimationFrame(loop), state.speed);
    }

    // --- NLP COMMAND PARSER ---
    const input = document.getElementById('cmd-input');
    const history = document.getElementById('history');

    input.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
            const cmd = input.value;
            printMsg(cmd, 'user');
            parseCommand(cmd);
            input.value = '';
        }
    });

    function printMsg(msg, type) {
        const div = document.createElement('div');
        div.className = `msg-${type}`;
        div.innerText = type === 'user' ? `> ${msg}` : msg;
        history.prepend(div);
    }

    function parseCommand(raw) {
        const cmd = raw.toUpperCase();

        if (cmd.includes('HELP')) {
            printMsg("--- PROTOCOLS ---", "sys");
            printMsg("SHIFT TO [FOREST/CITY/CUPBOARD]", "sys");
            printMsg("SPAWN [NUM] [AGENTS/GOALS/OBSTACLES]", "sys");
            printMsg("TRACK (Locks on random agent)", "sys");
            printMsg("SLOW / FAST / PAUSE", "sys");
            printMsg("TUI / CRT (Toggle View)", "sys");
            return;
        }

        // VISUALS
        if (cmd.includes('TUI')) {
            document.body.classList.add('tui-mode');
            state.mode = 'TUI';
            printMsg("VISUALS: TEXT_MODE_ONLY", "sys");
            return;
        }
        if (cmd.includes('CRT')) {
            document.body.classList.remove('tui-mode');
            state.mode = 'CRT';
            printMsg("VISUALS: PHOSPHOR_ENABLED", "sys");
            return;
        }

        // SPEED
        if (cmd.includes('SLOW')) { state.speed = 200; updateSpeedDisplay(); return; }
        if (cmd.includes('FAST')) { state.speed = 30; updateSpeedDisplay(); return; }
        if (cmd.includes('PAUSE') || cmd.includes('STOP')) { 
            state.running = !state.running; 
            printMsg(state.running ? "RESUMING..." : "SYSTEM HALTED", "sys");
            return; 
        }

        // TRACKING
        if (cmd.includes('TRACK')) {
            const agentCount = state.agents.filter(a => a.type === 'agent').length;
            if (agentCount > 0) {
                // Find a random agent index
                const agents = state.agents.map((a, i) => ({...a, realIdx: i})).filter(a => a.type === 'agent');
                const target = agents[Math.floor(Math.random() * agents.length)];
                state.trackedIndex = target.realIdx;
                printMsg(`TRACKING TARGET ID_${target.realIdx}`, "sys");
            } else {
                printMsg("NO AGENTS TO TRACK", "err");
            }
            return;
        }

        // SHIFTING
        if (cmd.includes('SHIFT') || cmd.includes('LOAD')) {
            let target = null;
            if (cmd.includes('FOREST')) target = 'FOREST';
            if (cmd.includes('CITY')) target = 'CITY';
            if (cmd.includes('CUPBOARD')) target = 'CUPBOARD';
            
            if(target) {
                state.currentScene = target;
                document.getElementById('hud-scene').innerText = target;
                spawnRipple(COLS/2, ROWS/2, 'SHIFT', target);
                printMsg(`REALITY REWRITE: ${target}`, "sys");
            } else {
                printMsg("UNKNOWN SCENARIO", "err");
            }
            return;
        }

        // SPAWNING
        if (cmd.includes('SPAWN') || cmd.includes('ADD')) {
            const num = parseInt(cmd.match(/\d+/)) || 10;
            let type = 'agent';
            if(cmd.includes('GOAL') || cmd.includes('FOOD')) type = 'goal';
            if(cmd.includes('OBS') || cmd.includes('WALL')) type = 'obs';
            
            for(let i=0; i<num; i++) {
                state.agents.push({
                    x: Math.floor(Math.random() * COLS),
                    y: Math.floor(Math.random() * ROWS),
                    type,
                    dead: false,
                    state: 'IDLE'
                });
            }
            spawnRipple(Math.random()*COLS, Math.random()*ROWS, 'SPAWN');
            printMsg(`INJECTED ${num} ENTITIES (${type})`, "sys");
            return;
        }

        // CLEAR
        if (cmd.includes('CLEAR') || cmd.includes('RESET')) {
            spawnRipple(COLS/2, ROWS/2, 'CLEAR');
            printMsg("GRID WIPED", "sys");
            return;
        }

        printMsg("COMMAND UNRECOGNIZED. TRY 'HELP'.", "err");
    }

    function spawnRipple(x, y, type, payload) {
        state.ripples.push({
            x, y, radius: 0, maxRadius: Math.max(COLS, ROWS),
            type, payload
        });
        if(type !== 'CLEAR') Audio.play("C4");
    }

    function updateSpeedDisplay() {
        document.getElementById('hud-speed').innerText = `${state.speed}ms`;
        printMsg(`TIME DILATION: ${state.speed}ms`, "sys");
    }

    function boot() {
        document.getElementById('boot').style.display = 'none';
        Audio.init();
        state.running = true;
        updateSpeedDisplay();
        printMsg("SYSTEM ONLINE. AWAITING INPUT.", "sys");
        
        // Intro animation
        setTimeout(() => {
            parseCommand("SHIFT TO CUPBOARD");
            setTimeout(() => parseCommand("SPAWN 5 AGENTS"), 1000);
            setTimeout(() => parseCommand("SPAWN 10 GOALS"), 1500);
        }, 500);
    }

    init();

</script>
</body>
</html>