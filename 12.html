<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAGINARY ECOLOGIES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes ripple {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Play = (props) => <IconWrapper {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconWrapper>;
        const Pause = (props) => <IconWrapper {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconWrapper>;
        const RefreshCw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></IconWrapper>;
        const Zap = (props) => <IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></IconWrapper>;
        const Disc = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></IconWrapper>;
        const Sparkles = (props) => <IconWrapper {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></IconWrapper>;
        const Wind = (props) => <IconWrapper {...props}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"></path><path d="M9.6 4.6A2 2 0 1 1 11 8H2"></path><path d="M12.6 19.4A2 2 0 1 0 14 16H2"></path></IconWrapper>;
        const Droplets = (props) => <IconWrapper {...props}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"></path><path d="M12.56 10a4.5 4.5 0 0 1 4.5 4.5c0 2-2.5 5.5-2.5 5.5S10 16.5 10 14.5A4.5 4.5 0 0 1 14.5 10v.06z"></path><path d="M18.6 6.5a2.5 2.5 0 0 1 2.5 2.5c0 1.1-1.4 3-1.4 3s-3.6-1.9-3.6-3a2.5 2.5 0 0 1 2.5-2.5z"></path></IconWrapper>;
        const Box = (props) => <IconWrapper {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></IconWrapper>;
        const MousePointer2 = (props) => <IconWrapper {...props}><path d="m12 6 2-2 2 2"></path><path d="M8 12h8"></path><path d="m12 18-2 2-2-2"></path></IconWrapper>;
        const Camera = (props) => <IconWrapper {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></IconWrapper>;
        const Loader2 = (props) => <IconWrapper {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></IconWrapper>;
        const Eye = (props) => <IconWrapper {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></IconWrapper>;
        const X = (props) => <IconWrapper {...props}><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></IconWrapper>;

        // --- GEMINI API UTILITIES ---
        const apiKey = ""; // Runtime environment provides this

        // Define Schemas for different LLM tasks
        const SIMULATION_SCHEMA = {
            type: "OBJECT",
            properties: {
                narrative: { type: "STRING" },
                entityUpdates: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            id: { type: "INTEGER" },
                            status: { type: "STRING" },
                            x: { type: "NUMBER" },
                            y: { type: "NUMBER" }
                        }
                    }
                },
                nextVectors: {
                    type: "ARRAY",
                    items: { type: "STRING" }
                }
            }
        };

        const WORLD_INIT_SCHEMA = {
            type: "OBJECT",
            properties: {
                entities: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            name: { type: "STRING" },
                            icon: { type: "STRING" },
                            status: { type: "STRING" },
                            x: { type: "NUMBER" },
                            y: { type: "NUMBER" }
                        }
                    }
                },
                initialVectors: {
                    type: "ARRAY",
                    items: { type: "STRING" }
                }
            }
        };

        // Text Generation (Logic & Narrative)
        const callGemini = async (prompt, systemInstruction, responseSchema) => {
            if (!apiKey) {
                // Determine which schema to mock based on responseSchema or analyze intent
                // Mock response logic since apiKey is empty
                if (responseSchema === WORLD_INIT_SCHEMA) {
                    return new Promise(resolve => setTimeout(() => resolve({
                        entities: Array.from({ length: 20 }, (_, i) => ({
                            name: `Mock Entity ${i}`,
                            icon: "ðŸŸ£",
                            status: "Mocked",
                            x: Math.random() * 80 + 10,
                            y: Math.random() * 80 + 10
                        })),
                        initialVectors: ["Mock V1", "Mock V2", "Mock V3"]
                    }), 1000));
                } else if (responseSchema === SIMULATION_SCHEMA) {
                    return new Promise(resolve => setTimeout(() => resolve({
                        narrative: "Simulation mode (No API Key). Entities drift in the void.",
                        entityUpdates: [],
                        nextVectors: ["Drift", "Wait", "Echo"]
                    }), 1000));
                }
                return {};
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            let attempt = 0;
            const maxRetries = 3;
            const delays = [1000, 2000, 4000];

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST', headers: {
                            'Content-Type'
                                : 'application/json'
                        }, body: JSON.stringify(payload)
                    }); if (!response.ok) throw new Error(`HTTP Error:
                ${response.status}`); const data = await response.json(); const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    return JSON.parse(text);
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error); if
                        (attempt === maxRetries - 1) throw error; await new Promise(r => setTimeout(r, delays[attempt]));
                    attempt++;
                }
            }
        };

        // Image Generation (Backgrounds/Atmosphere)
        const callImagen = async (prompt, mode = 'texture') => {
            if (!apiKey) return null; // Skip if no key
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

            // Construct prompt based on mode
            let enhancedPrompt = "";
            if (mode === 'perspective') {
                enhancedPrompt = `A first-person, macro photography perspective view from inside the scene: ${prompt}.
            Photorealistic, cinematic depth of field, immersive, highly detailed.`;
            } else {
                // UPDATED PROMPT: Superflat, Map-like, Schematic
                enhancedPrompt = `A top-down, superflat, orthographic game map of: ${prompt}. Schematic data visualization style,
            high contrast, distinct color regions, vector graphics, clean lines, no blur, minimap style, flat shading.`;
            }

            const payload = {
                instances: [{ prompt: enhancedPrompt }],
                parameters: { sampleCount: 1 }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Imagen Error: ${response.status}`);

                const data = await response.json();
                // Imagen prediction endpoint returns base64 directly
                if (data.predictions && data.predictions[0] && data.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                }
                return null;
            } catch (error) {
                console.error("Image generation failed:", error);
                return null;
            }
        };

        // --- DATA PRESETS ---
        const SCENES = {
            cupboard: {
                title: "The Cupboard",
                description: "Spacious yet dusty. Surfaces protected with plastic. Dark, with light seeping through cracks. Objects placed tightly. Silent.",
                entities: [
                    { name: "Tall Glass 1", icon: "ðŸ¥›" }, { name: "Tall Glass 2", icon: "ðŸ¥›" },
                    { name: "Short Glass A", icon: "ðŸ¥ƒ" }, { name: "Short Glass B", icon: "ðŸ¥ƒ" },
                    { name: "Plate Stack", icon: "ðŸ½ï¸" }, { name: "Ant Scout", icon: "ðŸœ" },
                    { name: "Glass Box", icon: "ðŸ§Š" }, { name: "Plastic Lid", icon: "â­•" },
                    { name: "Spider", icon: "ðŸ•·ï¸" }, { name: "Dust Bunny", icon: "ðŸ’¨" },
                    { name: "Cracked Mug", icon: "â˜•" }, { name: "Silver Spoon", icon: "ðŸ¥„" },
                    { name: "Moth", icon: "ðŸ¦‹" }, { name: "Old Receipt", icon: "ðŸ§¾" },
                    { name: "Ceramic Bowl", icon: "ðŸ¥£" }, { name: "Rubber Band", icon: "âž°" },
                    { name: "Wood Chip", icon: "ðŸªµ" }, { name: "Light Beam", icon: "âœ¨" },
                    { name: "Draft", icon: "ðŸŒ¬ï¸" }, { name: "Shadow", icon: "ðŸŒ‘" }
                ]
            },
            forest: {
                title: "Deep Forest",
                description: "Ancient, moss-covered trees. Damp earth. Bioluminescent fungi. The air hums with unseen life.",
                entities: [
                    { name: "Old Oak", icon: "ðŸŒ³" }, { name: "Fern", icon: "ðŸŒ¿" },
                    { name: "River Stone", icon: "ðŸª¨" }, { name: "Fox", icon: "ðŸ¦Š" },
                    { name: "Owl", icon: "ðŸ¦‰" }, { name: "Mycelium", icon: "ðŸ•¸ï¸" },
                    { name: "Dew Drop", icon: "ðŸ’§" }, { name: "Fallen Leaf", icon: "ðŸ‚" },
                    { name: "Beetle", icon: "ðŸª²" }, { name: "Moonlight", icon: "ðŸŒ™" },
                    { name: "Wind Gust", icon: "ðŸŒ¬ï¸" }, { name: "Pinecone", icon: "ðŸŒ²" },
                    { name: "Squirrel", icon: "ðŸ¿ï¸" }, { name: "Mushroom", icon: "ðŸ„" },
                    { name: "Worm", icon: "ðŸª±" }, { name: "Crow", icon: "ðŸ¦â€â¬›" },
                    { name: "Moss", icon: "ðŸŸ©" }, { name: "Stream", icon: "ðŸŒŠ" },
                    { name: "Deer", icon: "ðŸ¦Œ" }, { name: "Silence", icon: "ðŸ˜¶" }
                ]
            },
            void: {
                title: "Outer Space",
                description: "The endless vacuum. Distant starlight. Debris floating in zero gravity. Cold and silent.",
                entities: [
                    { name: "Satellite", icon: "ðŸ›°ï¸" }, { name: "Asteroid", icon: "â˜„ï¸" },
                    { name: "Star Dust", icon: "âœ¨" }, { name: "Void", icon: "âš«" },
                    { name: "Comet", icon: "ðŸŒ " }, { name: "Planetoid", icon: "ðŸª" },
                    { name: "Nebula Gas", icon: "ðŸŒ«ï¸" }, { name: "Solar Flare", icon: "â˜€ï¸" },
                    { name: "Ice Crystal", icon: "â„ï¸" }, { name: "Space Junk", icon: "ðŸ”©" },
                    { name: "Radio Wave", icon: "ðŸ“¡" }, { name: "Gravity Well", icon: "ðŸŒ€" },
                    { name: "Black Hole", icon: "ðŸ•³ï¸" }, { name: "Photon", icon: "âš¡" },
                    { name: "Alien Probe", icon: "ðŸ›¸" }, { name: "Cosmic Ray", icon: "ã€°ï¸" },
                    { name: "Dark Matter", icon: "â¬›" }, { name: "Time Dilation", icon: "â³" },
                    { name: "Supernova", icon: "ðŸ’¥" }, { name: "Observer", icon: "ðŸ‘ï¸" }
                ]
            }
        };

        // --- COMPONENTS ---

        const Entity = ({ entity, isSelected, onClick, style, neighbors = [] }) => (
            <div onClick={() => onClick(entity.id)}
                className={`absolute transition-all duration-1000 ease-in-out cursor-pointer flex flex-col items-center
                justify-center
                ${isSelected ? 'z-50 scale-125' : 'z-10 hover:scale-110 hover:z-40'}
                `}
                style={{
                    left: `${entity.x}%`,
                    top: `${entity.y}%`,
                    transform: 'translate(-50%, -50%)',
                    ...style
                }}
            >
                <div className={` text-3xl filter drop-shadow-lg select-none transition-all relative ${isSelected
                    ? 'brightness-125 drop-shadow-[0_0_15px_rgba(99,102,241,0.6)]' : 'brightness-90'} `}>
                    {entity.icon}

                    {/* Neighbor connection lines - UPDATED for Visibility */}
                    {isSelected && neighbors.length > 0 && (
                        <svg
                            className="absolute top-1/2 left-1/2 w-[500px] h-[500px] -translate-x-1/2 -translate-y-1/2 overflow-visible pointer-events-none z-0">
                            {neighbors.map((n, i) => {
                                // Calculate relative position for SVG line
                                // Note: SVG is centered on current entity, so current is 0,0 relative to center
                                // We need delta X/Y in percentages converted to rough pixels for visualization
                                const dx = (n.x - entity.x) * 10; // Simple scaler for visual representation
                                const dy = (n.y - entity.y) * 10;
                                return (
                                    <line key={i} x1="250" y1="250" x2={250 + dx} y2={250 + dy} stroke="#06b6d4" strokeWidth="2.5"
                                        strokeDasharray="6 4" className="opacity-90 drop-shadow-[0_0_3px_rgba(6,182,212,1)]" />
                                );
                            })}
                        </svg>
                    )}
                </div>

                <div className={` mt-1 text-[10px] uppercase tracking-wider font-bold bg-black/60 px-2 py-0.5 rounded
                    backdrop-blur-sm text-center whitespace-nowrap transition-opacity duration-300 ${isSelected
                        ? 'text-white border border-white/30' : 'text-gray-400 opacity-0 group-hover:opacity-100'} `}>
                    {entity.name}
                </div>
                {entity.status && (
                    <div className={` text-[8px] bg-indigo-900/80 text-indigo-200 px-1.5 py-0.5 rounded-full mt-0.5 max-w-[100px]
                    truncate transition-all duration-500 ${isSelected ? 'opacity-100' : 'opacity-0'} `}>
                        {entity.status}
                    </div>
                )}
            </div>
        );

        const VectorButton = ({ label, onClick, disabled }) => (
            <button onClick={onClick} disabled={disabled}
                className="group relative overflow-hidden bg-gray-900 border border-gray-700 hover:border-gray-400 text-gray-300 py-3 px-4 rounded-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-left w-full">
                <div
                    className="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-opacity" />
                <span className="relative font-mono text-sm tracking-widest uppercase flex items-center justify-between">
                    {label}
                    <Zap size={14} className="opacity-0 group-hover:opacity-100 transition-opacity text-yellow-400" />
                </span>
            </button>
        );

        const VisualRipple = ({ x, y }) => (
            <div className="absolute pointer-events-none z-0" style={{ left: `${x}%`, top: `${y}%` }}>
                <div
                    className="absolute w-[200px] h-[200px] rounded-full border-2 border-indigo-500/80 -translate-x-1/2 -translate-y-1/2 animate-[ripple_1.5s_ease-out_forwards]" />
                <div
                    className="absolute w-[300px] h-[300px] rounded-full border border-indigo-400/30 -translate-x-1/2 -translate-y-1/2 animate-[ripple_2.5s_ease-out_0.1s_forwards]" />
            </div>
        );

        // --- MAIN APP COMPONENT ---

        function ImaginaryEcologies() {
            // State
            const [mode, setMode] = useState('SETUP'); // SETUP, SIMULATION
            const [sceneData, setSceneData] = useState(null);
            const [entities, setEntities] = useState([]);
            const [history, setHistory] = useState([]);
            const [phase, setPhase] = useState('IDLE'); // IDLE, SELECT_ENTITY, SELECT_VECTOR, PROCESSING
            const [selectedEntityId, setSelectedEntityId] = useState(null);
            const [vectors, setVectors] = useState(['Observe', 'Interact', 'Wait']);
            const [autoPlay, setAutoPlay] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [isGeneratingWorld, setIsGeneratingWorld] = useState(false);
            const [visualRipples, setVisualRipples] = useState([]);

            // Image Generation State
            const [bgImage, setBgImage] = useState(null);
            const [perspectiveImage, setPerspectiveImage] = useState(null); // New state for POV
            const [isDreaming, setIsDreaming] = useState(false);
            const [isDreamingPerspective, setIsDreamingPerspective] = useState(false); // New state for POV loading

            // Custom Scene Form
            const [customDesc, setCustomDesc] = useState("A bustling neon cyber-market in the rain.");

            // Refs for AutoPlay
            const autoPlayTimer = useRef(null);

            // Helper: Get Nearest Neighbors
            const getNearestNeighbors = (entityId, count = 3) => {
                const current = entities.find(e => e.id === entityId);
                if (!current) return [];

                return entities
                    .filter(e => e.id !== entityId)
                    .map(e => ({
                        ...e,
                        dist: Math.sqrt(Math.pow(e.x - current.x, 2) + Math.pow(e.y - current.y, 2))
                    }))
                    .sort((a, b) => a.dist - b.dist)
                    .slice(0, count);
            };

            // Helper to generate custom world data via LLM
            const generateCustomWorld = async (description) => {
                const systemPrompt = `
            You are an expert world-builder. Create a balanced imaginary ecology based on the user's description.
            Generate exactly 20 distinct, non-human entities suitable for this environment.
            Assign appropriate emojis as icons.
            Assign 3 abstract, thematic initial 'vectors' (verbs or forces) for the world.
            Spread entities out with x,y coordinates between 10 and 90.
            `;
                const userPrompt = `Description: ${description}`;
                return await callGemini(userPrompt, systemPrompt, WORLD_INIT_SCHEMA);
            };

            // Initialize Simulation
            const startSimulation = async (presetKey) => {
                let initialEntities = [];
                let initialDesc = "";
                let initialVectors = ['Drift', 'Observe', 'Expand'];

                if (presetKey === 'custom') {
                    setIsGeneratingWorld(true);
                    initialDesc = customDesc;

                    try {
                        const worldData = await generateCustomWorld(customDesc);

                        if (worldData && worldData.entities) {
                            initialEntities = worldData.entities.map((e, i) => ({
                                id: i,
                                name: e.name,
                                icon: e.icon,
                                status: e.status || "Existing",
                                x: e.x || Math.random() * 80 + 10,
                                y: e.y || Math.random() * 80 + 10
                            }));
                            if (worldData.initialVectors) {
                                initialVectors = worldData.initialVectors;
                            }
                        } else {
                            throw new Error("Failed to generate valid world data");
                        }
                    } catch (error) {
                        console.error("World Generation Failed, falling back", error);
                        // Fallback generic generation
                        const icons = ["ðŸŸ¦", "ðŸ”º", "ðŸŸ ", "â­", "ðŸ’ ", "ðŸŒ€", "ðŸ§©", "ðŸ”®", "ðŸ§¿", "ðŸ§¬", "ðŸ¦ ", "ðŸ’¿", "ðŸ’¾", "ðŸ“¡", "ðŸ’¡", "ðŸ”­", "ðŸ”¬",
                            "ðŸ’Š", "ðŸ©¹", "ðŸ©¸"];
                        initialEntities = Array.from({ length: 20 }, (_, i) => ({
                            id: i,
                            name: `Entity ${i + 1}`,
                            icon: icons[i],
                            status: "Unknown",
                            x: Math.random() * 80 + 10,
                            y: Math.random() * 80 + 10
                        }));
                    }
                    setIsGeneratingWorld(false);
                } else {
                    const preset = SCENES[presetKey];
                    initialDesc = preset.description;
                    initialEntities = preset.entities.map((e, i) => ({
                        id: i,
                        ...e,
                        status: "Existing",
                        x: Math.random() * 80 + 10,
                        y: Math.random() * 80 + 10
                    }));
                }

                setSceneData({ description: initialDesc });
                setEntities(initialEntities);
                setHistory([{ text: `World initialized: ${initialDesc}`, type: 'system' }]);
                setVectors(initialVectors);
                setMode('SIMULATION');
                setPhase('SELECT_ENTITY');
                setBgImage(null); // Reset background
                setPerspectiveImage(null);
                setVisualRipples([]);

                // Trigger Background Generation
                generateWorldVisuals(initialDesc);
            };

            const generateWorldVisuals = async (description) => {
                setIsDreaming(true);
                const imageBase64 = await callImagen(description, 'texture');
                if (imageBase64) {
                    setBgImage(imageBase64);
                }
                setIsDreaming(false);
            };

            const generatePerspectiveView = async () => {
                if (!selectedEntityId && selectedEntityId !== 0) return;

                setIsDreamingPerspective(true);
                const entity = entities.find(e => e.id === selectedEntityId);
                const neighbors = getNearestNeighbors(selectedEntityId, 3);

                const neighborDesc = neighbors.length > 0
                    ? `Nearby entities include: ${neighbors.map(n => `${n.name} (${n.icon})`).join(', ')}.`
                    : "Alone in the vicinity.";

                const prompt = `A perspective view from the eyes of a ${entity.name} (${entity.icon}) situated in
            ${sceneData.description}. ${neighborDesc} The atmosphere is palpable.`;

                const imageBase64 = await callImagen(prompt, 'perspective');
                if (imageBase64) {
                    setPerspectiveImage({
                        src: imageBase64,
                        caption: `Perspective: ${entity.name}`
                    });
                }
                setIsDreamingPerspective(false);
            };

            // The Core Ripple Logic (Text LLM)
            const triggerRipple = async (entityId, vector) => {
                setIsLoading(true);
                setPhase('PROCESSING');

                const entity = entities.find(e => e.id === entityId);

                // Calculate Neighbors for Context
                const neighbors = getNearestNeighbors(entityId, 3);
                const neighborContext = neighbors.map(n => `${n.name} (type: ${n.icon}, dist: ${Math.round(n.dist)})`).join(', ');

                // Trigger Visual Ripple
                const rippleId = Date.now();
                setVisualRipples(prev => [...prev, { id: rippleId, x: entity.x, y: entity.y }]);
                setTimeout(() => {
                    setVisualRipples(prev => prev.filter(r => r.id !== rippleId));
                }, 3000);

                // Optimistic UI update for log
                setHistory(prev => [{ text: `Selected ${entity.name} â†’ Vector: ${vector}...`, type: 'pending' }, ...prev]);

                const systemPrompt = `
            You are the engine of an Imaginary Ecology simulation.
            The goal is to create emergent, surreal, and grounded interactions between nonhuman entities.
            Maintain object permanence but allow for poetic or physical transformations.
            IMPORTANT: Consider spatial proximity. The entity is reacting to its NEAREST NEIGHBORS provided in the context.

            Output JSON only.
            Rules:
            1. 'narrative': A concise, atmospheric description (1-2 sentences) of what happens. Mention specific interactions
            with neighbors if relevant.
            2. 'entityUpdates': An array of objects representing ONLY the entities that changed (moved, changed state, or
            status).
            - x/y: 0-100 coordinates.
            - status: Short string (e.g., "Vibrating", "Broken", "Growing").
            3. 'nextVectors': 3 distinct, abstract nouns or verbs for the NEXT turn (e.g., "Decay", "Merge", "Resist").
            `;

                const userPrompt = `
            Context: ${sceneData.description}
            Active Entity: ${entity.name} (${entity.status}).
            Nearest Neighbors: ${neighborContext}.
            Action: The entity '${entity.name}' enacts the vector '${vector}'.
            `;

                try {
                    const result = await callGemini(userPrompt, systemPrompt, SIMULATION_SCHEMA);

                    // Apply updates
                    if (result.entityUpdates) {
                        setEntities(prev => prev.map(e => {
                            const update = result.entityUpdates.find(u => u.id === e.id || u.name === e.name); // AI might map by name or ID, handle roughly
                            const matchedUpdate = update || (result.entityUpdates.find(u => u.name === e.name));

                            if (matchedUpdate) {
                                return {
                                    ...e,
                                    status: matchedUpdate.status || e.status,
                                    x: matchedUpdate.x !== undefined ? Math.max(5, Math.min(95, matchedUpdate.x)) : e.x,
                                    y: matchedUpdate.y !== undefined ? Math.max(5, Math.min(95, matchedUpdate.y)) : e.y
                                };
                            }
                            return e;
                        }));
                    }

                    setVectors(result.nextVectors || ['Static', 'Fade', 'Shift']);
                    setHistory(prev => [
                        { text: result.narrative, type: 'result', vector: vector, entity: entity.name },
                        ...prev.filter(h => h.type !== 'pending')
                    ]);

                    setSelectedEntityId(null);
                    setPhase('SELECT_ENTITY');

                } catch (error) {
                    console.error(error);
                    setHistory(prev => [{ text: "The simulation glitched. The ripple faded.", type: 'error' }, ...prev]);
                    setPhase('SELECT_ENTITY');
                } finally {
                    setIsLoading(false);
                }
            };

            // Interaction Handlers
            const handleEntityClick = (id) => {
                if (phase !== 'SELECT_ENTITY' && phase !== 'SELECT_VECTOR') return;
                setSelectedEntityId(id);
                setPhase('SELECT_VECTOR');
            };

            const handleVectorClick = (vector) => {
                if (selectedEntityId === null) return;
                triggerRipple(selectedEntityId, vector);
            };

            const handleBackgroundClick = (e) => {
                // Deselect if clicking background
                if (e.target === e.currentTarget) {
                    if (phase === 'SELECT_VECTOR') {
                        setPhase('SELECT_ENTITY');
                        setSelectedEntityId(null);
                    }
                }
            };

            // Auto Play Logic
            useEffect(() => {
                if (!autoPlay || mode !== 'SIMULATION') return;

                if (phase === 'SELECT_ENTITY' && !isLoading) {
                    autoPlayTimer.current = setTimeout(() => {
                        // Pick random entity
                        const randomId = entities[Math.floor(Math.random() * entities.length)].id;
                        setSelectedEntityId(randomId);
                        setPhase('SELECT_VECTOR');
                    }, 2000);
                } else if (phase === 'SELECT_VECTOR' && selectedEntityId !== null && !isLoading) {
                    autoPlayTimer.current = setTimeout(() => {
                        // Pick random vector
                        const randomVector = vectors[Math.floor(Math.random() * vectors.length)];
                        triggerRipple(selectedEntityId, randomVector);
                    }, 1500);
                }

                return () => clearTimeout(autoPlayTimer.current);
            }, [autoPlay, phase, entities, vectors, selectedEntityId, isLoading, mode]);


            // --- RENDERERS ---

            if (mode === 'SETUP') {
                return (
                    <div
                        className="min-h-screen bg-neutral-950 text-neutral-200 font-sans p-8 flex flex-col items-center justify-center relative overflow-hidden">
                        {/* Background Ambient */}
                        <div
                            className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/20 via-neutral-950 to-neutral-950 -z-10" />

                        <div className="max-w-2xl w-full space-y-8 z-10">
                            <div className="text-center space-y-2">
                                <h1
                                    className="text-5xl font-light tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-indigo-200 to-cyan-400">
                                    IMAGINARY ECOLOGIES
                                </h1>
                                <p className="text-neutral-500 font-mono text-sm tracking-widest uppercase">
                                    World Simulator â€¢ Emergent Systems â€¢ Nonhuman Perspectives
                                </p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {Object.entries(SCENES).map(([key, data]) => (
                                    <button key={key} onClick={() => startSimulation(key)}
                                        className="group p-6 bg-neutral-900/50 border border-neutral-800 hover:border-indigo-500/50
                            rounded-xl transition-all hover:bg-neutral-800 text-left"
                                    >
                                        <div className="text-2xl mb-2 group-hover:scale-110 transition-transform w-fit">
                                            {key === 'cupboard' ?
                                                <Box /> : key === 'forest' ?
                                                    <Wind /> :
                                                    <Disc />}
                                        </div>
                                        <h3 className="text-lg font-medium text-neutral-200">{data.title}</h3>
                                        <p className="text-xs text-neutral-500 mt-2 leading-relaxed line-clamp-3">
                                            {data.description}
                                        </p>
                                    </button>
                                ))}
                            </div>

                            <div className="p-6 bg-neutral-900/30 border border-neutral-800 rounded-xl">
                                <h3
                                    className="text-sm font-bold text-neutral-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                                    <Sparkles size={14} /> Custom Prime
                                </h3>
                                <textarea value={customDesc} onChange={(e) => setCustomDesc(e.target.value)}
                                    className="w-full bg-neutral-950 border border-neutral-800 rounded-lg p-3 text-sm text-neutral-300 focus:outline-none focus:border-indigo-500 transition-colors h-24 resize-none"
                                    placeholder="Describe a location (e.g., 'A flooded library where books float like jellyfish...')"
                                />
                                <button
                                    onClick={() => startSimulation('custom')}
                                    disabled={isGeneratingWorld}
                                    className="mt-4 w-full bg-indigo-900/20 border border-indigo-500/30 text-indigo-300 hover:bg-indigo-900/40 py-2 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-wait"
                                >
                                    {isGeneratingWorld ? (
                                        <>
                                            <Loader2 className="animate-spin" size={16} /> Populating Ecology...
                                        </>
                                    ) : (
                                        "Initialize Custom Simulation"
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // SIMULATION MODE
            return (
                <div className="h-screen w-screen bg-black text-neutral-200 flex overflow-hidden font-sans">

                    {/* LEFT: Simulation Canvas */}
                    <div
                        className="flex-1 relative bg-neutral-900/50 overflow-hidden cursor-crosshair transition-all duration-1000 shadow-inner"
                        onClick={handleBackgroundClick}
                    >
                        {/* Background "Floor" Layer */}
                        <div className="absolute inset-0 z-0 bg-neutral-950" />

                        {/* Generated Background Layer with "Raster" effects */}
                        {bgImage && (
                            <>
                                <div
                                    className="absolute inset-0 z-0 animate-in fade-in duration-1000 pointer-events-none"
                                    style={{
                                        backgroundImage: `url(${bgImage})`,
                                        backgroundSize: 'cover',
                                        backgroundPosition: 'center',
                                        filter: 'contrast(1.3) brightness(0.8) saturate(1.2)', // Pop the colors
                                    }}
                                />
                                {/* Scanline / Data Overlay */}
                                <div className="absolute inset-0 z-0 pointer-events-none opacity-20"
                                    style={{
                                        backgroundImage: 'linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,1) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06))',
                                        backgroundSize: '100% 4px, 6px 100%'
                                    }}
                                />
                            </>
                        )}

                        {/* Gameboard Grid & Vignette */}
                        <div className="absolute inset-0 z-0 opacity-20 pointer-events-none"
                            style={{
                                backgroundImage: `
                    linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), 
                    linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px)
                    `,
                                backgroundSize: '50px 50px'
                            }}
                        />
                        <div className="absolute inset-0 z-0 pointer-events-none bg-[radial-gradient(circle_at_center,transparent_30%,rgba(0,0,0,0.8)_100%)]" />

                        {/* Loading Indicator for Dream */}
                        {isDreaming && (
                            <div className="absolute bottom-6 right-6 z-40 bg-black/80 backdrop-blur-md text-neutral-300 px-4 py-2 rounded-lg text-xs font-mono border border-white/10 flex items-center gap-2 shadow-xl">
                                <Loader2 className="animate-spin text-indigo-400" size={14} />
                                Dreaming of the world...
                            </div>
                        )}

                        {/* Entities */}
                        {entities.map(entity => (
                            <Entity
                                key={entity.id}
                                entity={entity}
                                isSelected={selectedEntityId === entity.id}
                                onClick={handleEntityClick}
                                neighbors={selectedEntityId === entity.id ? getNearestNeighbors(entity.id, 3) : []}
                            />
                        ))}

                        {/* Visual Ripples */}
                        {visualRipples.map(ripple => (
                            <VisualRipple key={ripple.id} x={ripple.x} y={ripple.y} />
                        ))}

                        {/* Phase Indicator Overlay */}
                        <div className="absolute top-6 left-1/2 -translate-x-1/2 pointer-events-none z-50">
                            <div className={`
                    px-6 py-2 rounded-full border backdrop-blur-md transition-all duration-500 font-mono text-xs tracking-widest uppercase flex items-center gap-2 shadow-2xl
                    ${phase === 'PROCESSING'
                                    ? 'bg-amber-900/80 border-amber-500/50 text-amber-200'
                                    : phase === 'SELECT_ENTITY'
                                        ? 'bg-indigo-900/80 border-indigo-500/50 text-indigo-200'
                                        : 'bg-emerald-900/80 border-emerald-500/50 text-emerald-200'}
                `}>
                                {phase === 'PROCESSING' && <RefreshCw className="animate-spin" size={12} />}
                                {phase === 'SELECT_ENTITY' && <MousePointer2 className="animate-bounce" size={12} />}
                                {phase === 'SELECT_VECTOR' && <Zap className="animate-pulse" size={12} />}

                                {phase === 'SELECT_ENTITY' && "Select an Entity Perspective"}
                                {phase === 'SELECT_VECTOR' && "Select a Vector Force"}
                                {phase === 'PROCESSING' && "Simulating Ripple..."}
                            </div>
                        </div>

                        {/* PERSPECTIVE IMAGE OVERLAY */}
                        {perspectiveImage && (
                            <div className="absolute inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-8 animate-in fade-in duration-300">
                                <div className="relative max-w-4xl w-full bg-neutral-900 rounded-xl overflow-hidden border border-neutral-700 shadow-2xl">
                                    <img src={perspectiveImage.src} alt="Perspective View" className="w-full h-auto max-h-[80vh] object-contain" />
                                    <button
                                        onClick={() => setPerspectiveImage(null)}
                                        className="absolute top-4 right-4 bg-black/50 hover:bg-black/80 text-white p-2 rounded-full backdrop-blur-sm transition-all"
                                    >
                                        <X size={24} />
                                    </button>
                                    <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black via-black/80 to-transparent p-6 pt-12">
                                        <p className="text-white font-mono text-lg tracking-wider">{perspectiveImage.caption}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>

                    {/* RIGHT: Control Panel */}
                    <div className="w-96 bg-neutral-900 border-l border-neutral-800 flex flex-col z-50 shadow-2xl">

                        {/* Header */}
                        <div className="p-6 border-b border-neutral-800 bg-neutral-900 z-10">
                            <div className="flex items-center justify-between mb-2">
                                <h2 className="text-sm font-bold tracking-widest text-neutral-400 uppercase">Ecology Controls</h2>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => generateWorldVisuals(sceneData.description)}
                                        className="p-2 rounded-md bg-neutral-800 text-neutral-400 hover:text-white hover:bg-neutral-700 transition-colors"
                                        title="Regenerate World Visuals"
                                        disabled={isDreaming}
                                    >
                                        <Camera size={16} className={isDreaming ? 'opacity-50' : ''} />
                                    </button>
                                    <button
                                        onClick={() => setAutoPlay(!autoPlay)}
                                        className={`p-2 rounded-md transition-colors ${autoPlay ? 'bg-indigo-500 text-white' : 'bg-neutral-800 text-neutral-400 hover:text-white'}`}
                                        title="Toggle Auto Play"
                                    >
                                        {autoPlay ? <Pause size={16} /> : <Play size={16} />}
                                    </button>
                                </div>
                            </div>
                            <p className="text-xs text-neutral-500 line-clamp-2">{sceneData.description}</p>
                        </div>

                        {/* Dynamic Controls Area */}
                        <div className="flex-1 p-6 overflow-y-auto space-y-6">

                            {/* Vector Selection */}
                            <div className={`transition-all duration-500 space-y-3 ${phase === 'SELECT_VECTOR' ? 'opacity-100 translate-y-0' : 'opacity-50 blur-[1px]'}`}>
                                <div className="flex items-center justify-between">
                                    <h3 className="text-xs font-mono text-indigo-400 uppercase flex items-center gap-2">
                                        <Zap size={12} /> Available Vectors
                                    </h3>
                                    {phase === 'SELECT_VECTOR' && (
                                        <button
                                            onClick={generatePerspectiveView}
                                            disabled={isDreamingPerspective}
                                            className="text-[10px] bg-indigo-900/50 hover:bg-indigo-500 hover:text-white text-indigo-300 border border-indigo-500/30 px-2 py-1 rounded flex items-center gap-1 transition-all"
                                            title="Visualize what this entity sees"
                                        >
                                            {isDreamingPerspective ? <Loader2 className="animate-spin" size={10} /> : <Eye size={10} />}
                                            Visualize View
                                        </button>
                                    )}
                                </div>

                                <div className="space-y-2">
                                    {vectors.map((vector, idx) => (
                                        <VectorButton
                                            key={idx}
                                            label={vector}
                                            onClick={() => handleVectorClick(vector)}
                                            disabled={phase !== 'SELECT_VECTOR'}
                                        />
                                    ))}
                                </div>
                            </div>

                            {/* Narrative Log */}
                            <div className="mt-8">
                                <h3 className="text-xs font-mono text-neutral-500 mb-3 uppercase flex items-center gap-2">
                                    <Droplets size={12} /> Ripple Log
                                </h3>
                                <div className="space-y-4">
                                    {history.map((entry, i) => (
                                        <div key={i} className="text-sm border-l-2 border-neutral-800 pl-4 py-1 animate-in slide-in-from-left-2 fade-in duration-300">
                                            {entry.type === 'pending' ? (
                                                <span className="text-neutral-500 italic flex items-center gap-2">
                                                    <RefreshCw size={10} className="animate-spin" /> {entry.text}
                                                </span>
                                            ) : entry.type === 'system' ? (
                                                <span className="text-neutral-400 font-mono text-xs">{entry.text}</span>
                                            ) : (
                                                <p className="text-neutral-300">
                                                    <span className="text-xs text-indigo-400 font-bold uppercase tracking-wide mb-1 block">
                                                        {entry.entity && `${entry.entity} :: `}{entry.vector}
                                                    </span>
                                                    {entry.text}
                                                </p>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ImaginaryEcologies />);
    </script>
</body>

</html>