<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIPPLES v12.0 // OMNISCIENCE</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            background: black;
            color: #10b981;
            font-family: 'Courier New', Courier, monospace;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Mock Lucide components for React
        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const icon = window.lucide.icons[name];
                    if (icon) {
                        const svg = window.lucide.createIcons({
                            icons: { [name]: icon },
                            attrs: {
                                width: size,
                                height: size,
                                class: className
                            }
                        });
                    }
                }
            }, [name, size, className]);

            // Simple SVG mapping for common icons since UMD lucide is sometimes tricky in React
            // For RIPPLES v12, we'll use emojis or simple SVG wrappers where possible, 
            // but the mapping below is safer for a standalone build.

            const iconMap = {
                Play: <polygon points="5 3 19 12 5 21 5 3" fill="currentColor" />,
                Pause: <React.Fragment><rect x="6" y="4" width="4" height="16" fill="currentColor" /><rect x="14" y="4" width="4" height="16" fill="currentColor" /></React.Fragment>,
                Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" fill="currentColor" />,
                BrainCircuit: <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .52 5.586 3.003 3.003 0 0 0 5.193 2.516c.338.01.677.01 1.01 0a3.003 3.003 0 0 0 5.193-2.516 4 4 0 0 0 .52-5.586 4 4 0 0 0-2.526-5.77A3 3 0 0 0 12 5z" fill="none" stroke="currentColor" strokeWidth="2" />,
                X: <React.Fragment><line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" strokeWidth="2" /><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" strokeWidth="2" /></React.Fragment>,
                HelpCircle: <React.Fragment><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" strokeWidth="2" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="currentColor" strokeWidth="2" /><line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" strokeWidth="2" /></React.Fragment>,
                ArrowRight: <React.Fragment><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" /><polyline points="12 5 19 12 12 19" fill="none" stroke="currentColor" strokeWidth="2" /></React.Fragment>,
                Grid3X3: <React.Fragment><rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" strokeWidth="2" /><line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" strokeWidth="2" /><line x1="3" y1="15" x2="21" y2="15" stroke="currentColor" strokeWidth="2" /><line x1="9" y1="3" x2="9" y2="21" stroke="currentColor" strokeWidth="2" /><line x1="15" y1="3" x2="15" y2="21" stroke="currentColor" strokeWidth="2" /></React.Fragment>,
                Fingerprint: <React.Fragment><path d="M2 12a10 10 0 0 1 20 0" stroke="currentColor" strokeWidth="2" fill="none" /><path d="M5 12a7 7 0 0 1 14 0" stroke="currentColor" strokeWidth="2" fill="none" /><path d="M8 12a4 4 0 0 1 8 0" stroke="currentColor" strokeWidth="2" fill="none" /><path d="M12 12v.01" stroke="currentColor" strokeWidth="2" fill="none" /></React.Fragment>,
                Hammer: <React.Fragment><path d="m15 5 4 4" stroke="currentColor" strokeWidth="2" /><path d="M5 15l10-10l4 4l-10 10l-4-4Z" stroke="currentColor" strokeWidth="2" fill="none" /><path d="m2 18 3 3" stroke="currentColor" strokeWidth="2" /></React.Fragment>
            };

            const content = iconMap[name] || <circle cx="12" cy="12" r="5" fill="currentColor" />;

            return (
                <svg width={size} height={size} viewBox="0 0 24 24" className={className}>
                    {content}
                </svg>
            );
        };

        const BrainCircuit = (props) => <Icon name="BrainCircuit" {...props} />;
        const Play = (props) => <Icon name="Play" {...props} />;
        const Pause = (props) => <Icon name="Pause" {...props} />;
        const HelpCircle = (props) => <Icon name="HelpCircle" {...props} />;
        const ArrowRight = (props) => <Icon name="ArrowRight" {...props} />;
        const Grid3X3 = (props) => <Icon name="Grid3X3" {...props} />;
        const Fingerprint = (props) => <Icon name="Fingerprint" {...props} />;
        const Hammer = (props) => <Icon name="Hammer" {...props} />;
        const X = (props) => <Icon name="X" {...props} />;
        const Sparkles = (props) => <Icon name="Sparkles" {...props} />;
        const MousePointerClick = (props) => <Icon name="MousePointerClick" {...props} />;

        /**
        * RIPPLES v12.0: OMNISCIENCE
        */

        // --- 1. AUDIO ENGINE ---
        const useAudioEngine = () => {
            const [ctx, setCtx] = useState(null);
            const [master, setMaster] = useState(null);

            const initAudio = useCallback(() => {
                if (ctx) return;
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const mainGain = audioCtx.createGain();
                mainGain.gain.value = 0.4;
                const compressor = audioCtx.createDynamicsCompressor();
                mainGain.connect(compressor);
                compressor.connect(audioCtx.destination);
                setCtx(audioCtx);
                setMaster(mainGain);
            }, [ctx]);

            const playSound = useCallback((type, param) => {
                if (!ctx || !master) return;
                if (ctx.state === 'suspended') ctx.resume();
                const t = ctx.currentTime;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                if (type === 'PILOT') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(param, t);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.2, t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                    osc.connect(gain);
                } else if (type === 'GULL') {
                    const bSize = ctx.sampleRate * 0.15;
                    const b = ctx.createBuffer(1, bSize, ctx.sampleRate);
                    const d = b.getChannelData(0);
                    for (let i = 0; i < bSize; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bSize, 2);
                    const noise = ctx.createBufferSource(); noise.buffer = b;
                    const filter = ctx.createBiquadFilter(); filter.type = param === 'KICK' ? 'lowpass' : 'bandpass';
                    filter.frequency.value = param === 'KICK' ? 80 : 2000; filter.Q.value = 5;
                    noise.connect(filter); filter.connect(gain); gain.gain.setValueAtTime(0.4, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15); noise.start();
                } else if (type === 'GLASS') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1200, t);
                    osc.frequency.exponentialRampToValueAtTime(1180, t + 0.5);
                    gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5); osc.connect(gain);
                } else if (type === 'DATA') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(800, t);
                    osc.frequency.linearRampToValueAtTime(1200, t + 0.1); gain.gain.setValueAtTime(0.05, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.1); osc.connect(gain);
                } else if (type === 'UI') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, t); gain.gain.setValueAtTime(0.05, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1); osc.connect(gain);
                }
                gain.connect(master); osc.start(); osc.stop(t + 0.5);
            }, [ctx, master]);

            return { initAudio, playSound, ctx };
        };

        // --- 2. CONFIG & PROMPTS ---
        const PALETTE = [
            { id: 'ANT', char: 'A', color: 'text-emerald-400', bg: 'bg-emerald-900/30', icon: 'ðŸª²', desc: "Autonomous Agent. Seeks Goals. Avoids Obstacles." },
            { id: 'GOAL', char: 'G', color: 'text-amber-400', bg: 'bg-amber-900/30', icon: 'âš¡', desc: "Attractor. Emits a gravity signal that pulls Ants." },
            { id: 'OBSTACLE', char: 'O', color: 'text-red-500', bg: 'bg-red-900/30', icon: 'ðŸ›‘', desc: "Static Barrier. Blocks movement and causes friction." },
            { id: 'GLASS', char: '|', color: 'text-cyan-200', bg: 'bg-cyan-900/40', icon: 'â„ï¸', desc: "Resonant Wall. Reflects signals and sounds." },
            { id: 'DECAY', char: 'D', color: 'text-stone-500', bg: 'bg-stone-800', icon: 'â˜ ï¸', desc: "Entropy Engine. Slowly destroys adjacent cells." },
            { id: 'CIRCADIAN', char: 'C', color: 'text-yellow-200', bg: 'bg-yellow-900/50', icon: 'â˜€ï¸', desc: "Light Controller. Value to right (0-9) sets global brightness." },
            { id: 'NARRATIVE', char: ':', color: 'text-purple-400', bg: 'bg-purple-900/30', icon: 'ðŸ“œ', desc: "Story Node. Hit with Bang (*) to generate a Latent Log." },
            { id: 'BANG', char: '*', color: 'text-white', bg: 'bg-white/20', icon: 'ðŸ’¥', desc: "Event Trigger. Explodes instantly, activating neighbors." },
            { id: 'ERASER', char: '.', color: 'text-gray-600', bg: 'bg-gray-800/30', icon: 'ðŸ—‘ï¸', desc: "Void. Clears any cell to empty space." },
        ];

        const AGENT_SYSTEM_PROMPT = ` Role: You are a specific grid entity (Type: {TYPE}). Context: You are at the center of a 5x5 grid slice. Map: A=Ant, G=Goal(Attractor), O=Obstacle, |=Glass, D=Decay, .=Void. Task: 1. "PERCEIVE" : Describe your immediate subjective experience (Alien Phenomenology). e.g., "The friction to the north is unbearable." 2. "ACT" : If the user commands you, or if your internal drive compels you, PHYSICALLY MODIFY the grid. Output format (JSON): { "thought" : "Short narrative description of your state." , "changes" : [ {"r": 0, "c" : 1, "char" : "." } ] } `;
        const SECTOR_SYSTEM_PROMPT = ` Role: Grid Sector Mind. Task: You observe a specific sector of the cellular grid. Map Key: A=Ant, G=Goal, O=Obstacle, |=Glass, D=Decay, C=Light, :=Narrative, .=Void. Directives: 1. ANALYSIS: If user asks a question (e.g., "What is happening?" , "Analyze patterns" ), provide a deep, operative description. 2. ACTION: If user gives a command (e.g., "Build a wall" , "Clear area" ), output a JSON object to rewrite the grid. Format: { "thought" : "Log" , "changes" : [{"r":r,"c":c,"char":"CHAR"}] } 3. If no action is needed, just respond with plain text description. `;

        // --- 3. MAIN COMPONENT ---
        function RipplesOmniDeck() {
            const { initAudio, playSound, ctx } = useAudioEngine();
            const [cols, setCols] = useState(20);
            const [rows, setRows] = useState(15);
            const [grid, setGrid] = useState([]);
            const [tick, setTick] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [selectedTool, setSelectedTool] = useState(PALETTE[0]);
            const [lightLevel, setLightLevel] = useState(1.0);
            const [logs, setLogs] = useState([]);
            const [showLogs, setShowLogs] = useState(true);
            const [showHelp, setShowHelp] = useState(true);
            const [hoveredTool, setHoveredTool] = useState(null);
            const [selection, setSelection] = useState(new Set());
            const [isSelecting, setIsSelecting] = useState(false);
            const [neuroMode, setNeuroMode] = useState(null);
            const [activeContext, setActiveContext] = useState(null);
            const [llmInput, setLlmInput] = useState("");
            const [llmHistory, setLlmHistory] = useState([]);
            const [llmLoading, setLlmLoading] = useState(false);
            const longPressTimerRef = useRef(null);
            const gridRef = useRef(null);

            useEffect(() => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const cellSize = w < 768 ? 32 : 36;
                const c = Math.floor(w / cellSize);
                const r = Math.floor(h / cellSize);
                setCols(c);
                setRows(r);
                const newGrid = Array(r).fill().map(() => Array(c).fill('.'));
                for (let i = 0; i < 6; i++) newGrid[Math.floor(Math.random() * r)][Math.floor(Math.random() * c)] = 'A';
                for (let i = 0; i < 3; i++) newGrid[Math.floor(Math.random() * r)][Math.floor(Math.random() * c)] = 'G';
                if (newGrid[1]) {
                    newGrid[1][1] = 'C';
                    newGrid[1][2] = '8';
                }
                setGrid(newGrid);
                addLog("SYSTEM :: BOOT_SEQUENCE_COMPLETE");
            }, []);

            const addLog = (text, type = "SYS", data = null) => {
                setLogs(prev => [{ id: Date.now() + Math.random(), tick, text, type, data }, ...prev].slice(0, 40));
            };

            useEffect(() => {
                if (!isPlaying) return;
                const interval = setInterval(() => {
                    setTick(t => t + 1);
                    setGrid(g => {
                        const next = g.map(row => [...row]);
                        let audioEvents = new Set();
                        let newLight = lightLevel;

                        for (let r = 0; r < rows; r++) {
                            for (let c = 0; c < cols; c++) {
                                const cell = g[r][c];
                                if (cell === '*') { next[r][c] = '.'; continue; }
                                if (cell === '.') continue;
                                if (cell === 'C') {
                                    const val = parseInt(g[r][c + 1]);
                                    if (!isNaN(val)) newLight = newLight * 0.9 + (val / 9) * 0.1;
                                }
                                if (cell === 'D' && tick % 5 === 0) {
                                    const dirs = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                                    const d = dirs[Math.floor(Math.random() * dirs.length)];
                                    const nr = r + d[0], nc = c + d[1];
                                    if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && g[nr][nc] !== '.') {
                                        next[nr][nc] = '.'; audioEvents.add('DECAY');
                                    }
                                }
                                if (cell === 'A') {
                                    const moves = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                                    if (Math.random() < newLight) {
                                        const m = moves[Math.floor(Math.random() * moves.length)];
                                        const nr = r + m[0], nc = c + m[1];
                                        if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) {
                                            const target = g[nr][nc];
                                            if (target === '.') {
                                                next[r][c] = '.'; next[nr][nc] = 'A';
                                            } else if (target === 'G') {
                                                next[r][c] = '.'; next[nr][nc] = '*';
                                                audioEvents.add('EAT');
                                            } else if (target === 'O') {
                                                audioEvents.add('HIT');
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        setLightLevel(newLight);
                        if (audioEvents.has('EAT')) playSound('PILOT', 600 + Math.random() * 200);
                        if (audioEvents.has('HIT')) playSound('GULL', 'KICK');
                        if (audioEvents.has('DECAY')) playSound('DECAY', 0);
                        return next;
                    });
                }, 150);
                return () => clearInterval(interval);
            }, [isPlaying, rows, cols, playSound, lightLevel, tick]);

            const handlePointerDown = (e, r, c) => {
                if (!ctx) initAudio();
                if (e.button === 2) { e.preventDefault(); startSelection(r, c); return; }
                if (e.button === 0) { longPressTimerRef.current = setTimeout(() => startSelection(r, c), 500); }
            };

            const handlePointerEnter = (e, r, c) => {
                if (isSelecting) { updateSelection(r, c); return; }
                if (e.buttons === 1 && !isSelecting) {
                    if (longPressTimerRef.current) clearTimeout(longPressTimerRef.current);
                    const newGrid = [...grid];
                    newGrid[r][c] = selectedTool.char;
                    setGrid(newGrid);
                    playSound('PILOT', 200 + (c / cols) * 400);
                }
            };

            const handlePointerUp = (e, r, c) => {
                if (longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                    longPressTimerRef.current = null;
                    if (!isSelecting && r !== undefined && c !== undefined) {
                        const cell = grid[r][c];
                        if (cell !== '.' && cell !== '*') {
                            openEntityLink(r, c, cell);
                        }
                    }
                }
                if (isSelecting) {
                    setIsSelecting(false);
                    openSectorLink();
                }
            };

            const startSelection = (r, c) => {
                setIsSelecting(true);
                setSelection(new Set([`${r},${c}`]));
                playSound('DATA', 400);
            };

            const updateSelection = (r, c) => {
                if (!isSelecting) return;
                setSelection(prev => new Set(prev).add(`${r},${c}`));
            };

            const openEntityLink = (r, c, char) => {
                setNeuroMode('CHAT');
                setActiveContext({ r, c, char });
                setLlmHistory([]);
                setLlmInput("");
                setIsPlaying(false);
                playSound('GLASS', 0);
                // In standalone, we don't have an API key, so we'll just mock the response
                setLlmHistory([{ role: 'ENTITY', text: `ENTITY ${char} AT [${r},${c}] LINKED. (API_KEY_REQUIRED_FOR_AI)` }]);
            };

            const openSectorLink = () => {
                setNeuroMode('SECTOR');
                setActiveContext({ selection });
                setLlmHistory([]);
                setLlmInput("");
                setIsPlaying(false);
                playSound('DATA', 600);
                setLlmHistory([{ role: 'ENTITY', text: `SECTOR LINK ESTABLISHED. ${selection.size} CELLS ACCESSED. (API_KEY_REQUIRED_FOR_AI)` }]);
            };

            const handleLlmSubmit = (e) => {
                if (e) e.preventDefault();
                if (!llmInput) return;
                setLlmHistory(prev => [...prev, { role: 'USER', text: llmInput }]);
                setLlmInput("");
                setTimeout(() => {
                    setLlmHistory(prev => [...prev, { role: 'ENTITY', text: "LINK_ERROR: NO_API_KEY_FOUND. PLEASE CONFIGURE IN SOURCE." }]);
                    playSound('DATA', 0);
                }, 500);
            };

            const isSelected = (r, c) => selection.has(`${r},${c}`);
            const isFocused = (r, c) => {
                if (neuroMode !== 'CHAT' || !activeContext) return true;
                return Math.abs(r - activeContext.r) <= 2 && Math.abs(c - activeContext.c) <= 2;
            };

            const getStatusText = () => {
                if (neuroMode === 'SECTOR') return "LINKED: SECTOR MIND // QUERY STATUS OR COMMAND REWRITES";
                if (neuroMode === 'CHAT') return "LINKED: ENTITY // INTERROGATE OR COMMAND";
                if (isSelecting) return "SELECTING SECTOR... RELEASE TO LINK";
                if (hoveredTool) return `PALETTE: ${hoveredTool.id} // ${hoveredTool.desc.toUpperCase()}`;
                return "READY // CLICK TO PAINT // RIGHT-CLICK TO LINK SECTOR // TAP ENTITY TO CHAT";
            };

            return (
                <div className="fixed inset-0 bg-black text-emerald-500 font-mono overflow-hidden select-none"
                    onContextMenu={e => e.preventDefault()}
                    onPointerUp={(e) => handlePointerUp(e)}
                >
                    <div className="absolute inset-0 z-10 transition-colors duration-500 pointer-events-none"
                        style={{ backgroundColor: neuroMode === 'CHAT' ? 'rgba(0,0,0,0.85)' : 'transparent' }} />

                    <div ref={gridRef}
                        className="absolute inset-0 z-0 grid touch-none"
                        style={{
                            gridTemplateColumns: `repeat(${cols}, 1fr)`,
                            gridTemplateRows: `repeat(${rows}, 1fr)`
                        }}>
                        {grid.map((row, r) => row.map((cell, c) => {
                            const tool = PALETTE.find(p => p.char === cell);
                            const active = isSelected(r, c);
                            const focused = isFocused(r, c);
                            return (
                                <div key={`${r}-${c}`}
                                    onPointerDown={(e) => handlePointerDown(e, r, c)}
                                    onPointerEnter={(e) => handlePointerEnter(e, r, c)}
                                    className={`
                                        flex items-center justify-center text-sm font-bold border-[0.5px] transition-all duration-300
                                        ${neuroMode === 'CHAT' && focused ? 'z-20 border-emerald-400 shadow-[0_0_10px_emerald]' : 'z-0'}
                                        ${active ? 'border-amber-400 bg-amber-900/40 z-30 scale-105' : 'border-emerald-900/10'}
                                        ${!active && cell === '.' ? 'bg-black' : ''}
                                        ${!active && cell !== '.' ? (tool?.bg || 'bg-gray-800') : ''}
                                        ${cell === '*' ? 'bg-white animate-pulse' : (tool?.color || 'text-gray-500')}
                                        ${!focused && neuroMode === 'CHAT' ? 'opacity-20 blur-[1px]' : 'opacity-100'}
                                    `}
                                >
                                    {cell !== '.' ? cell : ''}
                                </div>
                            );
                        }))}
                    </div>

                    <div className="absolute top-0 w-full p-4 flex justify-between pointer-events-none z-40">
                        <div className="bg-black/90 p-2 rounded border border-emerald-900 shadow-lg pointer-events-auto flex flex-col gap-1">
                            <h1 className="text-xs font-bold tracking-widest text-emerald-100 flex items-center gap-2">
                                <BrainCircuit size={14} className={isSelecting ? "text-amber-400 animate-pulse" : "text-emerald-500"} />
                                RIPPLES <span className="text-emerald-700">v12.0</span>
                            </h1>
                            <div className="flex gap-3 text-[10px] text-emerald-700 font-bold">
                                <span>{neuroMode ? ":: LINKED ::" : ":: READY ::"}</span>
                                <button onClick={() => setShowHelp(true)} className="flex items-center gap-1 hover:text-emerald-400 cursor-pointer">
                                    <HelpCircle size={10} /> HELP
                                </button>
                            </div>
                        </div>
                        <button onClick={() => { if (!ctx) initAudio(); setIsPlaying(!isPlaying); }}
                            className="pointer-events-auto bg-black/80 p-3 rounded-full border border-emerald-900 text-emerald-500 hover:text-emerald-200">
                            {isPlaying ? <Pause size={20} /> : <Play size={20} />}
                        </button>
                    </div>

                    <div className="absolute bottom-20 left-0 w-full flex justify-center pointer-events-none z-30">
                        <div className="bg-black/80 backdrop-blur border-t border-b border-emerald-900/50 px-4 py-1 text-[10px] text-emerald-400 font-bold uppercase tracking-widest shadow-lg">
                            {getStatusText()}
                        </div>
                    </div>

                    <div className="absolute bottom-4 left-4 right-4 flex gap-2 overflow-x-auto pb-2 pointer-events-auto z-40 scrollbar-hide">
                        {PALETTE.map(tool => (
                            <button key={tool.id} onClick={() => { setSelectedTool(tool); playSound('UI', 0); }}
                                onMouseEnter={() => setHoveredTool(tool)} onMouseLeave={() => setHoveredTool(null)}
                                className={`flex-shrink-0 w-12 h-12 rounded border flex flex-col items-center justify-center gap-1 backdrop-blur
                                ${selectedTool.id === tool.id ? 'bg-emerald-900/80 border-emerald-400 text-emerald-100' : 'bg-black/80 border-emerald-900/50 text-emerald-700'}`}
                            >
                                <span className="text-lg">{tool.icon}</span>
                                <span className="text-[8px] font-bold">{tool.char}</span>
                            </button>
                        ))}
                    </div>

                    {showHelp && (
                        <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="w-full max-w-2xl bg-[#0a0a0a] border border-emerald-500/50 rounded-lg shadow-2xl p-6 relative overflow-hidden">
                                <button onClick={() => setShowHelp(false)} className="absolute top-4 right-4 text-emerald-700 hover:text-emerald-400">
                                    <X size={24} />
                                </button>
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="w-12 h-12 bg-emerald-900/20 rounded-full flex items-center justify-center border border-emerald-500/30">
                                        <BrainCircuit size={24} className="text-emerald-400" />
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-bold text-emerald-100 tracking-widest">RIPPLES <span className="text-sm text-emerald-600">v12.0</span></h2>
                                        <div className="text-xs text-emerald-700">OMNISCIENCE OPERATING SYSTEM</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div className="space-y-4">
                                        <h3 className="text-sm font-bold text-emerald-400 border-b border-emerald-900 pb-1 flex items-center gap-2">
                                            <MousePointerClick size={14} /> CONTROLS
                                        </h3>
                                        <ul className="text-xs space-y-2 text-emerald-300/80">
                                            <li className="flex gap-2"><span className="text-white font-bold w-4">L</span><span><strong>Left-Click & Drag:</strong> Paint terrain.</span></li>
                                            <li className="flex gap-2"><span className="text-white font-bold w-4">R</span><span><strong>Right-Click & Drag:</strong> Link Sector.</span></li>
                                            <li className="flex gap-2"><span className="text-white font-bold w-4">Tap</span><span><strong>Click Entity:</strong> Chat/Command.</span></li>
                                        </ul>
                                    </div>
                                    <div className="space-y-4">
                                        <h3 className="text-sm font-bold text-amber-400 border-b border-amber-900 pb-1">NEURO-LINK</h3>
                                        <ul className="text-xs space-y-2 text-amber-300/80">
                                            <li><strong>Sector Link:</strong> Select an area to chat with the Grid Mind.</li>
                                            <li><strong>Agent Chat:</strong> Talk to specific Ants/Goals.</li>
                                        </ul>
                                    </div>
                                </div>
                                <button onClick={() => { setShowHelp(false); if (!ctx) initAudio(); setIsPlaying(true); }}
                                    className="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 text-black font-bold py-3 rounded text-sm flex items-center justify-center gap-2"
                                >
                                    INITIALIZE SYSTEM <ArrowRight size={16} />
                                </button>
                            </div>
                        </div>
                    )}

                    {neuroMode && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center p-4">
                            <div className={`w-full max-w-lg bg-[#0a0a0a] border rounded-lg shadow-2xl overflow-hidden flex flex-col max-h-[60vh]
                                ${neuroMode === 'SECTOR' ? 'border-amber-500/50' : 'border-purple-500/50'}`}>
                                <div className={`p-4 border-b flex justify-between items-center
                                    ${neuroMode === 'SECTOR' ? 'bg-amber-900/20 border-amber-500/30 text-amber-400' : 'bg-purple-900/20 border-purple-500/30 text-purple-400'}`}>
                                    <div className="flex items-center gap-2 font-bold">
                                        {neuroMode === 'SECTOR' ? <Grid3X3 size={18} /> : <Fingerprint size={18} />}
                                        <span>{neuroMode === 'SECTOR' ? `SECTOR_LINK :: ${activeContext.selection.size} CELLS` : `ENTITY_LINK :: TYPE_${activeContext?.char}`}</span>
                                    </div>
                                    <button onClick={() => { setNeuroMode(null); setIsPlaying(true); setSelection(new Set()); }}><X size={20} /></button>
                                </div>
                                <div className="flex-1 p-4 overflow-y-auto space-y-4">
                                    {llmHistory.map((msg, i) => (
                                        <div key={i} className={`flex ${msg.role === 'USER' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] p-3 rounded text-xs leading-relaxed ${msg.role === 'USER' ? 'bg-emerald-900/20 text-emerald-300 border border-emerald-900/50' :
                                                msg.role === 'ACTION' ? 'bg-amber-900/20 text-amber-300 border border-amber-900/50 italic' :
                                                    'bg-purple-900/20 text-purple-300 border border-purple-900/50'
                                                }`}>
                                                {msg.role === 'ACTION' && <Hammer size={10} className="inline mr-1" />}
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <form onSubmit={handleLlmSubmit} className="p-4 border-t border-gray-800 bg-black/40">
                                    <div className="relative">
                                        <input autoFocus value={llmInput} onChange={e => setLlmInput(e.target.value)}
                                            placeholder={neuroMode === 'SECTOR' ? "QUERY OR COMMAND SECTOR..." : "QUERY OR COMMAND ENTITY..."}
                                            className={`w-full bg-black border p-3 pl-4 pr-10 text-sm focus:outline-none rounded font-mono uppercase
                                            ${neuroMode === 'SECTOR' ? 'border-amber-700 text-amber-100' : 'border-purple-700 text-purple-100'}`}
                                        />
                                        <button type="submit" disabled={!llmInput} className="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-gray-500 hover:text-white disabled:opacity-30">
                                            <ArrowRight size={16} />
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RipplesOmniDeck />);
    </script>
</body>

</html>