<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORCA // REBUS_PIPELINE_V25</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="ripple-ai.js"></script>
    <style>
        :root {
            --bg: #111;
            --fg: #eee;
            --accent: #00bcd4;
            --gold: #ffd700;
            --red: #ff3333;
            --dim: #444;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            height: 44px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            background: rgba(0, 0, 0, 0.9);
            flex-shrink: 0;
        }

        .thesis {
            font-size: 12px;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .mode-btns {
            display: flex;
            gap: 5px;
        }

        .btn-mode {
            padding: 4px 8px;
            background: #222;
            border: 1px solid #444;
            color: #888;
            font-size: 10px;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-mode.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        /* GRID DISPLAY - ALWAYS 50VH */
        .grid-display {
            height: 50vh;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            flex-shrink: 0;
            position: relative;
        }

        #rebus-display {
            white-space: pre;
            font-size: 9px;
            line-height: 11px;
            color: var(--fg);
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
            padding: 10px;
        }

        /* Interactive Tokens */
        .token {
            cursor: pointer;
            transition: all 0.2s;
        }

        .token:hover,
        .token.active {
            color: var(--accent);
            text-shadow: 0 0 8px var(--accent);
        }

        .token-sound:hover,
        .token-sound.active {
            color: var(--gold);
            text-shadow: 0 0 8px var(--gold);
        }

        .token-alarm:hover,
        .token-alarm.active {
            color: var(--red);
            text-shadow: 0 0 8px var(--red);
        }

        /* TABBED PANEL - BOTTOM HALF */
        .panel-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #080808;
            min-height: 0;
        }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 5px;
            background: transparent;
            border: none;
            color: #666;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ZONES TAB */
        .zone-item {
            padding: 10px;
            border: 1px solid #222;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zone-item:active,
        .zone-item.active {
            border-color: var(--accent);
            background: rgba(0, 188, 212, 0.1);
        }

        .z-name {
            color: var(--accent);
            font-weight: bold;
            font-size: 12px;
        }

        .z-op {
            color: #666;
            font-size: 10px;
        }

        /* LEGEND TAB */
        .key-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dotted #222;
            font-size: 11px;
        }

        .key-row span:first-child {
            color: var(--gold);
        }

        /* TRANSLATION TAB */
        .trans-output {
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 15px;
            min-height: 40px;
        }

        .trans-history {
            font-size: 10px;
            color: #666;
            max-height: 150px;
            overflow-y: auto;
        }

        .trans-history div {
            padding: 4px 0;
            border-bottom: 1px dotted #222;
        }

        /* EXPAND/COLLAPSE BUTTON */
        .expand-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            background: rgba(0, 188, 212, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            z-index: 10;
        }

        /* EXPANDED MODE */
        body.expanded .grid-display {
            height: calc(100vh - 44px);
        }

        body.expanded .panel-area {
            display: none;
        }

        /* CRT MODE */
        body.mode-crt {
            background: #050a05;
            color: #0f0;
        }

        body.mode-crt #rebus-display {
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }

        body.mode-crt::after {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(transparent 50%, rgba(0, 0, 0, 0.2) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>

<body>

    <div class="header">
        <div class="thesis">NON VERBIS, SED REBUS</div>
        <div class="mode-btns">
            <button class="btn-mode active" onclick="App.setMode('ICONIC')">ICONIC</button>
            <button class="btn-mode" onclick="App.setMode('CRT')">CRT</button>
        </div>
    </div>

    <!-- GRID DISPLAY - 50VH -->
    <div class="grid-display">
        <div id="rebus-display"></div>
        <button class="expand-btn" onclick="App.toggleExpand()">⤢</button>
    </div>

    <!-- TABBED PANELS -->
    <div class="panel-area">
        <div class="tab-bar">
            <button class="tab-btn active" onclick="App.showTab('zones')">ZONES</button>
            <button class="tab-btn" onclick="App.showTab('legend')">LEGEND</button>
            <button class="tab-btn" onclick="App.showTab('decode')">DECODE</button>
        </div>

        <div class="tab-content active" id="tab-zones"></div>
        <div class="tab-content" id="tab-legend"></div>
        <div class="tab-content" id="tab-decode">
            <div class="trans-output" id="trans-text">Tap tokens to decode.</div>
            <button class="expand-btn" onclick="App.promptSynthesis()"
                style="position:static; margin-bottom:10px; width:100%; height:auto; padding:5px; font-size:11px; background:rgba(0,188,212,0.1);">✨
                PROMPT SYNTHESIS</button>
            <div id="ai-synthesis"
                style="font-size:11px; color:var(--gold); border:1px solid var(--gold); padding:10px; margin-bottom:15px; display:none; background:rgba(255,215,0,0.05);">
            </div>
            <div style="font-size:10px; color:#666; margin-bottom:10px;">HISTORY:</div>
            <div class="trans-history" id="trans-history"></div>
        </div>
    </div>

    <script>
        const ZONES = [
            { id: "Z1", name: "INVOCATION", op: "PRODUCE", act: "INVOCATION" },
            { id: "Z2", name: "BRIDGE", op: "REPAIR", act: "DECREE" },
            { id: "Z3", name: "OPTICS", op: "PRODUCE", act: "CHANT" },
            { id: "Z4", name: "EVIDENCE", op: "MAINTAIN", act: "DECREE" },
            { id: "Z5", name: "FRACTURE", op: "REPAIR", act: "QUESTION" },
            { id: "Z6", name: "SEAL", op: "TRANSFORM", act: "SEAL" }
        ];

        const LEGEND = [
            { t: "(o)", m: "Eye / Lens / Optics POV" },
            { t: "/_\\", m: "Roof / House Container" },
            { t: "~~~", m: "Diffusion / Blue Hour" },
            { t: "[]", m: "Box / Containment" },
            { t: "{}", m: "Secret / Hidden" },
            { t: "___", m: "Ground / Floor" },
            { t: "/\\/\\", m: "Ridge / High Ground" },
            { t: "--->", m: "Bridge / Pipeline" },
            { t: "!=", m: "Alarm / Anomaly" },
            { t: "$", m: "Value / Cost" },
            { t: "?", m: "Doubt / Fracture" },
            { t: "ROYGBIV", m: "Refracted Spectrum" }
        ];

        const RAW_SHIELD = `
               (o)   (o)
              /  \\___/  \\       ROYGBIV -> RAINBOW
           __/____________\\__
          /                  \\
         /    [TXT]--->[PRM]  \\
        /   ----------------   \\
       |   R O L E :  [MC]      |
       |                        |
       |   E D G A R - V I S I O N
       |     (o)=EYE   /_\\=ROOF
       |    ___GREAT___DIFFUSION___
       |   ~~~BLUE~~~HOUR~~~(o)~~~
       |                        |
       |  [GLASS] = [PRISM] -> R/O/Y/G/B/I/V
       |      /\\/\\  refract  /\\/\\
       |                        |
       |  [TWIN]  (o)(o)  [CIRCLES]
       |   GLASSES on ___RUG___ !=ALARM
       |                        |
       |  CONVEX > gather PHOTON$ > INFER
       |  CONCAVE < desk HIGH RIDGE < FLOOR
       |                        |
       |  [BOX]{SECRET}: [LAMBCHOP] scent
       |  [TOY] = [ANTLER] $40 (cold)
       |  [TOOL]= [GLOW-BALL] (dim) ~~~
       |                        |
       |  EDGAR-VISION TOGGLE:
       |  2=TOO 4=FOR 8=ATE C=SEE U=YOU R=ARE
       |  PHOSPHOR: trail trail ---> footprints
       |  SPECULAR: glasses catch ---> sensor
       |                        |
       |  Q? "NOT ALONE" = [MYSTERIOUS][BLANK]
        \\                       /
         \\____  HISTORY  _____/
              \\___over___/
                  TIME
`;

        const App = {
            mode: 'ICONIC',
            expanded: false,
            history: [],

            init() {
                this.renderZones();
                this.renderShield();
                this.renderLegend();
                AudioEngine.init();
            },

            setMode(m) {
                this.mode = m;
                document.body.classList.remove('mode-crt');
                if (m === 'CRT') document.body.classList.add('mode-crt');
                document.querySelectorAll('.btn-mode').forEach(b => {
                    b.classList.toggle('active', b.innerText === m);
                });
            },

            toggleExpand() {
                this.expanded = !this.expanded;
                document.body.classList.toggle('expanded', this.expanded);
            },

            showTab(id) {
                document.querySelectorAll('.tab-btn').forEach((b, i) => {
                    b.classList.toggle('active', b.innerText.toLowerCase().includes(id.slice(0, 4)));
                });
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById('tab-' + id).classList.add('active');
            },

            renderZones() {
                const list = document.getElementById('tab-zones');
                ZONES.forEach(z => {
                    const el = document.createElement('div');
                    el.className = 'zone-item';
                    el.innerHTML = `<div class="z-name">${z.id}: ${z.name}</div><div class="z-op">${z.op} // ${z.act}</div>`;
                    el.onclick = () => {
                        document.querySelectorAll('.zone-item').forEach(e => e.classList.remove('active'));
                        el.classList.add('active');
                        AudioEngine.play('E4');
                    };
                    list.appendChild(el);
                });
            },

            renderLegend() {
                const list = document.getElementById('tab-legend');
                LEGEND.forEach(l => {
                    const el = document.createElement('div');
                    el.className = 'key-row';
                    el.innerHTML = `<span>${l.t}</span><span>${l.m}</span>`;
                    list.appendChild(el);
                });
            },

            renderShield() {
                const display = document.getElementById('rebus-display');
                let html = RAW_SHIELD.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                const tokens = [
                    { k: "\\(o\\)", c: "token" },
                    { k: "\\[.*?\\]", c: "token" },
                    { k: "\\{.*?\\}", c: "token" },
                    { k: "~~~", c: "token" },
                    { k: "ROYGBIV", c: "token" },
                    { k: "/\\\\/\\\\", c: "token" },
                    { k: "!=", c: "token-alarm" },
                    { k: "\\$([0-9]+)?", c: "token" },
                    { k: " trail ", c: "token" },
                    { k: "---&gt;", c: "token" },
                    { k: "\\bC\\b", c: "token-sound" },
                    { k: "\\bU\\b", c: "token-sound" },
                    { k: "\\bR\\b", c: "token-sound" },
                    { k: "\\b2\\b", c: "token-sound" },
                    { k: "\\b4\\b", c: "token-sound" },
                    { k: "\\b8\\b", c: "token-sound" }
                ];

                tokens.forEach(tk => {
                    const regex = new RegExp(`(${tk.k})`, 'g');
                    html = html.replace(regex, `<span class="${tk.c}" onclick="App.interact(this)" ontouchstart="App.interact(this)">$1</span>`);
                });

                display.innerHTML = html;
            },

            interact(el) {
                const txt = el.innerText;

                // Visual feedback
                el.classList.add('active');
                setTimeout(() => el.classList.remove('active'), 300);

                // Find meaning
                const entry = LEGEND.find(l => txt.includes(l.t));
                let msg = "Processing...";

                if (entry) msg = entry.m;
                else if (txt.includes("trail")) msg = "Repetition Operator: Path/Cycle";
                else if (txt.match(/[CUR248]/)) msg = "Phonetic Substitute (Sound)";
                else if (txt.includes("TXT")) msg = "Raw Input (Narrative)";
                else if (txt.includes("PRM")) msg = "Prompt Object";
                else if (txt.includes("BLANK")) msg = "Shadow / Void / Unknown";

                // Update decode tab
                document.getElementById('trans-text').innerHTML = `<strong>[${txt}]</strong><br>${msg}`;

                // Add to history
                this.history.unshift(`[${txt}] = ${msg}`);
                if (this.history.length > 20) this.history.pop();
                document.getElementById('trans-history').innerHTML = this.history.map(h => `<div>${h}</div>`).join('');

                // Sound
                if (txt === "C") AudioEngine.play("C4");
                else if (txt === "U") AudioEngine.play("D4");
                else if (txt === "R") AudioEngine.play("E4");
                else if (txt === "2") AudioEngine.play("F4");
                else if (txt === "4") AudioEngine.play("G4");
                else if (txt === "8") AudioEngine.play("A4");
                else AudioEngine.play("click");
            },

            async promptSynthesis() {
                const output = document.getElementById('ai-synthesis');
                const historyStr = this.history.join('\n');

                if (this.history.length === 0) {
                    output.style.display = 'block';
                    output.innerText = "ERROR: DECODE HISTORY EMPTY. ADD TOKENS FIRST.";
                    return;
                }

                output.style.display = 'block';
                output.innerText = "> AGGREGATING REBUS VECTORS... SYNTHESIZING NARRATIVE...";

                try {
                    const prompt = `DECODED VECTORS:\n${historyStr}\n\nProvide a "Unified Narrative Vector" (2 sentences) that synthesizes these symbols into a final conclusion about Edgar, the Golden Hound, and the Appalachian Void.`;

                    const synthesis = await RIPPLE_AI.call(prompt, "You are the Master Synthesist of the Rebus Pipeline.");
                    output.innerText = synthesis;
                } catch (error) {
                    output.innerText = "ERROR: NEURAL BRIDGE FAIL. CHECK OLLAMA.";
                }
            }
        };

        const AudioEngine = {
            synth: null,
            init() {
                if (this.synth) return;
                Tone.start();
                this.synth = new Tone.PolySynth(Tone.Synth).toDestination();
                this.synth.volume.value = -10;
            },
            play(note) {
                this.init();
                if (note === 'click') this.synth.triggerAttackRelease("C6", "32n", Tone.now(), 0.1);
                else this.synth.triggerAttackRelease(note, "8n");
            }
        };

        App.init();
    </script>
</body>

</html>